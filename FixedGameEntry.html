<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Samsara Saga - Act 1: The Awakening</title>
    
    <!-- Meta Tags -->
    <meta name="description" content="Begin your spiritual journey through the village of Dharmapura. Experience the first awakening in this interactive philosophical adventure.">
    <meta name="keywords" content="spiritual journey, Hindu philosophy, interactive story, Act 1, dharma, awakening">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Marcellus:wght@400&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* === CRITICAL LOADING STYLES === */
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #0a0908 0%, #1a1817 50%, #2a2827 100%);
            color: #c5c1b9;
            font-family: 'Marcellus', serif;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .critical-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle, #1a1817 0%, #0a0908 70%);
            z-index: 10000;
            transition: opacity 1s ease;
        }
        
        .critical-loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-symbol {
            width: 120px;
            height: 120px;
            margin-bottom: 2rem;
            position: relative;
        }
        
        .dharma-wheel {
            width: 100%;
            height: 100%;
            border: 3px solid rgba(224, 150, 88, 0.3);
            border-radius: 50%;
            position: relative;
            animation: rotate 20s linear infinite;
        }
        
        .dharma-wheel::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background: #e09658;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px rgba(224, 150, 88, 0.6);
        }
        
        .dharma-spokes {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 80%;
            background: linear-gradient(to bottom, transparent, #e09658, transparent);
            transform-origin: center;
            transform: translate(-50%, -50%);
        }
        
        .spoke-1 { transform: translate(-50%, -50%) rotate(0deg); }
        .spoke-2 { transform: translate(-50%, -50%) rotate(45deg); }
        .spoke-3 { transform: translate(-50%, -50%) rotate(90deg); }
        .spoke-4 { transform: translate(-50%, -50%) rotate(135deg); }
        .spoke-5 { transform: translate(-50%, -50%) rotate(180deg); }
        .spoke-6 { transform: translate(-50%, -50%) rotate(225deg); }
        .spoke-7 { transform: translate(-50%, -50%) rotate(270deg); }
        .spoke-8 { transform: translate(-50%, -50%) rotate(315deg); }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: #e09658;
            margin-bottom: 1rem;
            text-shadow: 0 0 15px rgba(224, 150, 88, 0.5);
            animation: glow 3s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 15px rgba(224, 150, 88, 0.5); }
            to { text-shadow: 0 0 25px rgba(224, 150, 88, 0.8); }
        }
        
        .loading-subtitle {
            font-size: 1.1rem;
            color: #a97142;
            text-align: center;
            margin-bottom: 2rem;
            font-style: italic;
        }
        
        .loading-progress {
            width: 300px;
            height: 6px;
            background: rgba(224, 150, 88, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #e09658, #a97142, #e09658);
            background-size: 200% 100%;
            border-radius: 3px;
            width: 0%;
            transition: width 0.5s ease;
            animation: shimmer 2s linear infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .loading-status {
            font-size: 0.9rem;
            color: #8a7a6a;
            text-align: center;
            min-height: 1.5rem;
        }
        
        /* === ERROR HANDLING === */
        .error-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #2a1817 0%, #1a0908 70%);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            color: #c5c1b9;
            text-align: center;
            padding: 2rem;
        }
        
        .error-container.show {
            display: flex;
        }
        
        .error-icon {
            font-size: 4rem;
            color: #ef4444;
            margin-bottom: 2rem;
        }
        
        .error-title {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: #ef4444;
            margin-bottom: 1rem;
        }
        
        .error-message {
            font-size: 1.1rem;
            max-width: 600px;
            line-height: 1.6;
            margin-bottom: 2rem;
        }
        
        .error-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .error-btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(145deg, #e09658, #a97142);
            border: none;
            border-radius: 8px;
            color: #0a0908;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Marcellus', serif;
            font-weight: bold;
        }
        
        .error-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(224, 150, 88, 0.4);
        }
        
        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .loading-text {
                font-size: 1.5rem;
            }
            
            .loading-symbol {
                width: 80px;
                height: 80px;
            }
            
            .loading-progress {
                width: 250px;
            }
            
            .error-actions {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <!-- Critical Loading Screen -->
    <div class="critical-loading" id="critical-loading">
        <div class="loading-symbol">
            <div class="dharma-wheel">
                <div class="dharma-spokes spoke-1"></div>
                <div class="dharma-spokes spoke-2"></div>
                <div class="dharma-spokes spoke-3"></div>
                <div class="dharma-spokes spoke-4"></div>
                <div class="dharma-spokes spoke-5"></div>
                <div class="dharma-spokes spoke-6"></div>
                <div class="dharma-spokes spoke-7"></div>
                <div class="dharma-spokes spoke-8"></div>
            </div>
        </div>
        <div class="loading-text">Samsara Saga</div>
        <div class="loading-subtitle">Act 1: The Awakening</div>
        <div class="loading-progress">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="loading-status" id="loading-status">Preparing your spiritual journey...</div>
    </div>
    
    <!-- Error Container -->
    <div class="error-container" id="error-container">
        <div class="error-icon">‚ö†Ô∏è</div>
        <h1 class="error-title">Journey Interrupted</h1>
        <p class="error-message" id="error-message">
            We encountered a challenge while preparing your spiritual adventure. Even on the path to enlightenment, obstacles can arise.
        </p>
        <div class="error-actions">
            <button class="error-btn" onclick="restartJourney()">üîÑ Restart Journey</button>
            <a href="index.html" class="error-btn">üè† Return Home</a>
            <a href="CB-fixed.html" class="error-btn">üåü Create New Character</a>
        </div>
    </div>
    
    <!-- Main Game Container -->
    <div id="game-container" style="display: none;">
        <!-- Game content will be populated by the Working Game Controller -->
    </div>
    
    <!-- Core System Scripts -->
    <script>
        // === CRITICAL INITIALIZATION SYSTEM ===
        
        class CriticalGameLoader {
            constructor() {
                this.loadingProgress = 0;
                this.initializationSteps = [
                    { name: 'Checking browser compatibility...', duration: 200 },
                    { name: 'Loading spiritual systems...', duration: 500 },
                    { name: 'Initializing story engine...', duration: 800 },
                    { name: 'Preparing character data...', duration: 400 },
                    { name: 'Creating sacred interface...', duration: 600 },
                    { name: 'Establishing cosmic connection...', duration: 300 },
                    { name: 'Journey ready!', duration: 200 }
                ];
                this.currentStep = 0;
                this.hasError = false;
                
                // Start the loading process
                this.startLoading();
            }
            
            startLoading() {
                console.log('üöÄ Starting Critical Game Loader...');
                this.executeNextStep();
            }
            
            executeNextStep() {
                if (this.currentStep >= this.initializationSteps.length) {
                    this.completeLoading();
                    return;
                }
                
                const step = this.initializationSteps[this.currentStep];
                this.updateStatus(step.name);
                
                // Simulate step execution
                setTimeout(() => {
                    this.currentStep++;
                    this.updateProgress();
                    
                    // Add some actual loading logic for key steps
                    switch (this.currentStep) {
                        case 1:
                            if (!this.checkCompatibility()) {
                                return; // Stop execution if compatibility fails
                            }
                            break;
                        case 2:
                            this.loadSystems();
                            break;
                        case 3:
                            this.initializeStory();
                            break;
                        case 4:
                            this.loadCharacterData();
                            break;
                        case 5:
                            this.setupInterface();
                            break;
                    }
                    
                    if (!this.hasError) {
                        this.executeNextStep();
                    }
                }, step.duration);
            }
            
            updateProgress() {
                const progress = (this.currentStep / this.initializationSteps.length) * 100;
                const progressBar = document.getElementById('progress-bar');
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
                this.loadingProgress = progress;
            }
            
            updateStatus(message) {
                const statusElement = document.getElementById('loading-status');
                if (statusElement) {
                    statusElement.textContent = message;
                }
                console.log('üìä Loading:', message);
            }
            
            checkCompatibility() {
                console.log('üîç Checking browser compatibility...');
                
                // Check for localStorage
                try {
                    if (typeof localStorage === 'undefined') {
                        this.showError('Browser missing required feature: localStorage');
                        return false;
                    }
                    // Test localStorage write/read
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                } catch (e) {
                    this.showError('localStorage is not functional (may be in private mode)');
                    return false;
                }
                
                // Check for JSON
                if (typeof JSON === 'undefined' || typeof JSON.parse !== 'function') {
                    this.showError('Browser missing required feature: JSON support');
                    return false;
                }
                
                // Check for addEventListener (on document)
                if (typeof document.addEventListener !== 'function') {
                    this.showError('Browser missing required feature: addEventListener');
                    return false;
                }
                
                // Check for querySelector (on document)
                if (typeof document.querySelector !== 'function') {
                    this.showError('Browser missing required feature: querySelector');
                    return false;
                }
                
                // Check for basic ES6 features
                try {
                    // Test arrow functions, const/let, template literals
                    const testArrow = () => `test`;
                    if (testArrow() !== 'test') {
                        throw new Error('Arrow functions not working');
                    }
                } catch (e) {
                    this.showError('Browser missing required feature: Modern JavaScript (ES6)');
                    return false;
                }
                
                console.log('‚úÖ Browser compatibility check passed');
                return true;
            }
            
            loadSystems() {
                // Load the critical game systems
                this.loadScript('FixedACT1StorySystem.js')
                    .then(() => this.loadScript('WorkingGameController.js'))
                    .then(() => {
                        console.log('‚úÖ Core systems loaded');
                    })
                    .catch(error => {
                        console.warn('Some systems failed to load, proceeding with fallback:', error);
                        // Don't show error - the Working Game Controller has fallbacks
                    });
            }
            
            loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = () => {
                        console.warn(`Failed to load script: ${src}`);
                        resolve(); // Resolve anyway to continue with fallbacks
                    };
                    document.head.appendChild(script);
                });
            }
            
            initializeStory() {
                // The Working Game Controller will handle story initialization
                console.log('üìö Story initialization delegated to Working Game Controller');
            }
            
            loadCharacterData() {
                // Check URL parameters for character data
                const urlParams = new URLSearchParams(window.location.search);
                const nakshatra = urlParams.get('nakshatra');
                
                if (nakshatra) {
                    console.log('‚úÖ Character data found in URL parameters');
                } else {
                    console.log('‚ÑπÔ∏è No character data in URL, will check localStorage');
                }
            }
            
            setupInterface() {
                // Prepare the game container
                const gameContainer = document.getElementById('game-container');
                if (gameContainer) {
                    gameContainer.style.display = 'block';
                }
                console.log('üé® Interface setup complete');
            }
            
            completeLoading() {
                console.log('üéâ Loading complete, starting game...');
                
                // Hide loading screen
                const loadingScreen = document.getElementById('critical-loading');
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 1000);
                }
                
                // Initialize the Working Game Controller
                setTimeout(() => {
                    try {
                        if (window.WorkingGameController) {
                            window.gameController = new window.WorkingGameController();
                            console.log('‚úÖ Game Controller initialized successfully');
                        } else {
                            console.warn('WorkingGameController not available, showing fallback');
                            this.showMinimalFallback();
                        }
                    } catch (error) {
                        console.error('Failed to initialize Game Controller:', error);
                        this.showMinimalFallback();
                    }
                }, 500);
            }
            
            showError(message) {
                this.hasError = true;
                console.error('‚ùå Critical loading error:', message);
                
                const errorContainer = document.getElementById('error-container');
                const errorMessage = document.getElementById('error-message');
                
                if (errorMessage) {
                    errorMessage.textContent = message;
                }
                
                if (errorContainer) {
                    errorContainer.classList.add('show');
                }
                
                // Hide loading screen
                const loadingScreen = document.getElementById('critical-loading');
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
            }
            
            showMinimalFallback() {
                console.log('üîß Activating minimal fallback mode...');
                
                // Hide loading screen if it exists
                const loadingScreen = document.getElementById('critical-loading');
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
                
                // Create or get game container
                let gameContainer = document.getElementById('game-container');
                if (!gameContainer) {
                    gameContainer = document.createElement('div');
                    gameContainer.id = 'game-container';
                    document.body.appendChild(gameContainer);
                }
                
                gameContainer.innerHTML = `
                    <div style="padding: 2rem; max-width: 800px; margin: 0 auto; color: #c5c1b9; min-height: 100vh; display: flex; flex-direction: column; justify-content: center;">
                        <header style="text-align: center; margin-bottom: 3rem;">
                            <h1 style="color: #e09658; font-size: 2.5rem; margin-bottom: 0.5rem; text-shadow: 0 0 10px rgba(224, 150, 88, 0.5);">Samsara Saga</h1>
                            <h2 style="color: #a97142; font-size: 1.5rem; font-style: italic;">Act 1: The Awakening</h2>
                            <p style="color: #8a7a6a; font-size: 0.9rem; margin-top: 1rem;">Minimal Mode - Core Systems Unavailable</p>
                        </header>
                        
                        <main style="background: rgba(26, 24, 23, 0.8); padding: 2rem; border-radius: 15px; border: 1px solid rgba(224, 150, 88, 0.3); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);">
                            <h3 style="color: #e09658; margin-bottom: 1rem;">Your Journey Begins</h3>
                            <p style="margin-bottom: 1.5rem; line-height: 1.8;">
                                You find yourself in the peaceful village of Dharmapura, where ancient wisdom meets everyday challenges. 
                                As you begin to understand the deeper mysteries of existence, you sense that this place holds the keys to spiritual awakening.
                            </p>
                            <p style="margin-bottom: 2rem; font-style: italic; color: #a97142; background: rgba(224, 150, 88, 0.05); padding: 1rem; border-left: 3px solid #e09658; border-radius: 0 8px 8px 0;">
                                The cosmic winds stir as consciousness takes form, and your path of discovery begins...
                            </p>
                            
                            <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem;">
                                <button onclick="exploreVillage()" style="background: linear-gradient(145deg, #e09658, #a97142); border: none; padding: 1rem 2rem; border-radius: 8px; color: #0a0908; font-weight: bold; cursor: pointer; font-size: 1rem; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                    üèòÔ∏è Explore the village to understand the situation
                                </button>
                                <button onclick="seekGuidance()" style="background: linear-gradient(145deg, #e09658, #a97142); border: none; padding: 1rem 2rem; border-radius: 8px; color: #0a0908; font-weight: bold; cursor: pointer; font-size: 1rem; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                    üïâÔ∏è Seek spiritual guidance from the temple
                                </button>
                                <button onclick="helpVillagers()" style="background: linear-gradient(145deg, #e09658, #a97142); border: none; padding: 1rem 2rem; border-radius: 8px; color: #0a0908; font-weight: bold; cursor: pointer; font-size: 1rem; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                    ü§ù Approach the villagers to offer help
                                </button>
                            </div>
                            
                            <hr style="border: none; border-top: 1px solid rgba(224, 150, 88, 0.3); margin: 2rem 0;">
                            
                            <div style="text-align: center;">
                                <h4 style="color: #e09658; margin-bottom: 1rem;">Experiencing Issues?</h4>
                                <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">
                                    <button onclick="location.reload()" style="background: rgba(224, 150, 88, 0.2); border: 1px solid #e09658; padding: 0.75rem 1.5rem; border-radius: 5px; color: #e09658; cursor: pointer; font-weight: bold;">
                                        üîÑ Reload Full Experience
                                    </button>
                                    <button onclick="window.location.href='CB-fixed.html'" style="background: rgba(99, 180, 209, 0.2); border: 1px solid #63b4d1; padding: 0.75rem 1.5rem; border-radius: 5px; color: #63b4d1; cursor: pointer; font-weight: bold;">
                                        üåü Create New Character
                                    </button>
                                    <button onclick="window.location.href='index.html'" style="background: rgba(169, 113, 66, 0.2); border: 1px solid #a97142; padding: 0.75rem 1.5rem; border-radius: 5px; color: #a97142; cursor: pointer; font-weight: bold;">
                                        üè† Return Home
                                    </button>
                                </div>
                                <p style="margin-top: 1rem; font-size: 0.9rem; color: #8a7a6a;">
                                    For the best experience, please use a modern browser like Chrome, Firefox, Safari, or Edge.
                                </p>
                            </div>
                        </main>
                    </div>
                `;
                
                gameContainer.style.display = 'block';
                console.log('‚úÖ Minimal fallback mode activated successfully');
            }
        }
        
        // Global functions for minimal fallback
        function exploreVillage() {
            showFallbackMessage("You walk through the village, observing the delicate balance of daily life and spiritual practice. Your wisdom grows through careful observation.");
        }
        
        function seekGuidance() {
            showFallbackMessage("At the temple, you meet Guruji, who teaches you about Vicheda‚Äîthe separation between sacred and mundane. Your spiritual insight deepens.");
        }
        
        function helpVillagers() {
            showFallbackMessage("You practice deep listening with the villagers, truly understanding their concerns. Your compassion blossoms as you connect with their hearts.");
        }
        
        function showFallbackMessage(message) {
            alert(message + "\n\nThis is a simplified version. Please reload to try the full experience, or return to the character creation to start fresh.");
        }
        
        function restartJourney() {
            // Clear any saved data
            try {
                localStorage.removeItem('samsaraSaga_workingGame');
                localStorage.removeItem('samsaraSaga_fixedACT1_save');
                localStorage.removeItem('samsaraSagaUnified');
            } catch (error) {
                console.warn('Could not clear saved data:', error);
            }
            
            // Reload the page
            location.reload();
        }
        
        // === ERROR HANDLING ===
        
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error);
            
            // Don't show error screen for minor issues
            if (event.error && event.error.message && event.error.message.includes('Script error')) {
                return;
            }
            
            // Only show critical errors during loading
            if (!window.gameController && !window.workingGameController) {
                const loader = document.querySelector('.critical-loading');
                if (loader && !loader.classList.contains('hidden')) {
                    // We're still loading, so this is a critical error
                    setTimeout(() => {
                        if (window.criticalLoader) {
                            window.criticalLoader.showError('A technical issue occurred during initialization. Please try restarting your journey.');
                        }
                    }, 2000);
                }
            }
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            console.warn('Unhandled promise rejection:', event.reason);
            // Don't show error screen for promise rejections unless they're critical
        });
        
        // === START LOADING ===
        
        // Initialize the critical loader immediately
        window.criticalLoader = new CriticalGameLoader();
        
        console.log('üåü Fixed Game Entry Point v2 loaded successfully');
    </script>
</body>
</html>
