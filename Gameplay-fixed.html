<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Samsara Saga - Journey Through Existence</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Marcellus&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Link to the external CSS files -->
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="atmospheric-ui-system.css">
    <link rel="stylesheet" href="fixed-banyan-puzzle.css">
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to content</a>

    <!-- Animated Background -->
    <div id="vignette-overlay"></div>
    <div id="particle-background"></div>

    <!-- Custom Cursor -->
    <div id="cursor-container">
        <svg class="chakra-cursor" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#e09658" stroke-width="1">
            <circle cx="12" cy="12" r="10"/>
            <g transform="translate(12,12)">
                <path d="M0,-10 L 2,-8 L 0,-6 L -2,-8 Z" transform="rotate(0)"/>
                <path d="M0,-10 L 2,-8 L 0,-6 L -2,-8 Z" transform="rotate(30)"/>                
                <path d="M0,-10 L 2,-8 L 0,-6 L -2,-8 Z" transform="rotate(60)"/>
                <path d="M0,-10 L 2,-8 L 0,-6 L -2,-8 Z" transform="rotate(90)"/>
                <path d="M0,-10 L 2,-8 L 0,-6 L -2,-8 Z" transform="rotate(120)"/>
                <path d="M0,-10 L 2,-8 L 0,-6 L -2,-8 Z" transform="rotate(150)"/>
                <path d="M0,-10 L 2,-8 L 0,-6 L -2,-8 Z" transform="rotate(180)"/>
                <path d="M0,-10 L 2,-8 L 0,-6 L -2,-8 Z" transform="rotate(210)"/>
                <path d="M0,-10 L 2,-8 L 0,-6 L -2,-8 Z" transform="rotate(240)"/>
                <path d="M0,-10 L 2,-8 L 0,-6 L -2,-8 Z" transform="rotate(270)"/>
                <path d="M0,-10 L 2,-8 L 0,-6 L -2,-8 Z" transform="rotate(300)"/>
                <path d="M0,-10 L 2,-8 L 0,-6 L -2,-8 Z" transform="rotate(330)"/>
            </g>
            <circle cx="12" cy="12" r="2" fill="#e09658"/>
        </svg>
    </div>

    <!-- Page Transition Effect -->
    <div class="page-transition">
        <div class="page-transition-mandala"></div>
    </div>

    <!-- Top Bar with Title and Menu -->
    <header class="game-header">
        <div class="header-title">Samsara Saga</div>
        <button class="menu-toggle-button" id="menu-button">
            <i class="fas fa-bars"></i>
            <span>Menu</span>
        </button>
    </header>

    <!-- Main wrapper for the entire game interface -->
    <div class="game-wrapper">
        <!-- Main content area for narrative and choices (Left Column) -->
        <main class="story-panel" id="main-content">
            <div id="story-container" class="section">
                <div id="story-text" class="text-fade-in">
                    <p>Loading your journey...</p>
                </div>
            </div>
            <div id="puzzle-container" class="text-fade-in-delay-1"></div>
            <div id="choices-container" class="text-fade-in-delay-1">
                <button class="choice-button" onclick="initializeGame()">
                    <span class="choice-icon"><i class="fas fa-play"></i></span>
                    <span class="choice-content">Begin Journey</span>
                </button>
            </div>
        </main>
        
        <!-- Sidebar for player stats and game controls (Right Column) -->
        <aside class="status-panel">
            <div class="character-summary">
                <div class="character-symbol">
                    <svg viewBox="0 0 100 100" id="character-symbol-svg">
                        <circle cx="50" cy="50" r="40" stroke="#e09658" stroke-width="2" fill="none"/>
                        <circle cx="50" cy="50" r="20" stroke="#e09658" stroke-width="2" fill="none"/>
                        <circle cx="50" cy="50" r="5" fill="#e09658"/>
                    </svg>
                </div>
                <h2 class="character-name" id="character-name">Jiva</h2>
            </div>
            
            <div class="panel-section">
                <h3 class="panel-title">Spiritual Attributes</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">Karma</span> 
                        <div class="stat-bar karma-bar"><div id="karma-fill" style="width: 50%;"></div></div>
                        <span id="karma-value" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Sattva</span> 
                        <div class="stat-bar sattva-bar"><div id="sattva-fill" style="width: 30%;"></div></div>
                        <span id="sattva-value" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Rajas</span> 
                        <div class="stat-bar rajas-bar"><div id="rajas-fill" style="width: 80%;"></div></div>
                        <span id="rajas-value" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Tamas</span> 
                        <div class="stat-bar tamas-bar"><div id="tamas-fill" style="width: 10%;"></div></div>
                        <span id="tamas-value" class="stat-value">0</span>
                    </div>
                </div>
            </div>
            
            <div class="panel-section">
                 <h3 class="panel-title">Elemental Affinity</h3>
                 <div class="element-display" id="element-display">
                    <div class="element-icon"><i class="fas fa-star"></i></div>
                    <div class="element-name">Ether</div>
                 </div>
            </div>
            
            <div class="panel-section">
                <h3 class="panel-title">Inventory</h3>
                <ul id="inventory-list">
                    <li class="inventory-empty">(Empty)</li>
                </ul>
            </div>

            <div class="game-controls">
                <button class="control-button" id="new-game-btn">
                    <i class="fas fa-sync-alt"></i> Begin Anew
                </button>
            </div>
        </aside>
    </div>

    <!-- Game Menu Modal -->
    <div class="modal" id="game-menu-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Game Menu</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="menu-buttons">
                    <button class="menu-button" id="character-profile-btn"><i class="fas fa-user"></i><span>Character Profile</span></button>
                    <button class="menu-button" id="save-game-btn"><i class="fas fa-save"></i><span>Save Game</span></button>
                    <button class="menu-button" id="load-game-btn"><i class="fas fa-folder-open"></i><span>Load Game</span></button>
                    <button class="menu-button" id="settings-btn"><i class="fas fa-cog"></i><span>Settings</span></button>
                    <button class="menu-button" id="help-btn"><i class="fas fa-question-circle"></i><span>Help</span></button>
                    <button class="menu-button" id="exit-game-btn"><i class="fas fa-sign-out-alt"></i><span>Exit to Main Menu</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification System -->
    <div id="notification-container"></div>

    <!-- Load all JavaScript files with proper error handling -->
    <script>
        // Global variables for game state
        window.gameInitialized = false;
        window.gameStateManager = null;
        window.storyEngine = null;
        window.currentScene = null;
        
        // Script loading with dependencies
        const scriptsToLoad = [
            'nakshatraData.js',
            'ACT1storyData.js',
            'ACT2storyData.js', 
            'ACT3storyData.js',
            'GameStateManager.js',
            'StoryEngine.js'
        ];
        
        let loadedScripts = 0;
        const totalScripts = scriptsToLoad.length;
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log(`✓ Loaded: ${src}`);
                    loadedScripts++;
                    resolve();
                };
                script.onerror = () => {
                    console.error(`✗ Failed to load: ${src}`);
                    reject(new Error(`Failed to load ${src}`));
                };
                document.head.appendChild(script);
            });
        }
        
        // Load scripts sequentially
        async function loadAllScripts() {
            try {
                for (const script of scriptsToLoad) {
                    await loadScript(script);
                }
                console.log('✓ All core scripts loaded successfully');
                
                // Try to load optional enhancement scripts
                const optionalScripts = [
                    'puzzles.js',
                    'PuzzleEngine.js',
                    'fixed-banyan-puzzle.js'
                ];
                
                for (const script of optionalScripts) {
                    try {
                        await loadScript(script);
                    } catch (e) {
                        console.warn(`Optional script ${script} failed to load, continuing without it`);
                    }
                }
                
                // Initialize game after all scripts are loaded
                setTimeout(initializeGameSafely, 100);
                
            } catch (error) {
                console.error('Critical script loading failed:', error);
                showError('Failed to load game. Please refresh the page.');
            }
        }
        
        function initializeGameSafely() {
            try {
                console.log('🎮 Initializing Samsara Saga...');
                
                // Initialize GameStateManager
                if (typeof GameStateManager !== 'undefined') {
                    window.gameStateManager = new GameStateManager();
                    console.log('✓ GameStateManager initialized');
                } else {
                    throw new Error('GameStateManager not available');
                }
                
                // Initialize StoryEngine
                if (typeof StoryEngine !== 'undefined') {
                    window.storyEngine = new StoryEngine(window.gameStateManager);
                    console.log('✓ StoryEngine initialized');
                } else {
                    throw new Error('StoryEngine not available');
                }
                
                // Set up character from URL parameters
                setupCharacterFromURL();
                
                // Initialize the story
                initializeStory();
                
                // Set up event listeners
                setupEventListeners();
                
                window.gameInitialized = true;
                console.log('🌟 Game successfully initialized!');
                
            } catch (error) {
                console.error('Game initialization failed:', error);
                showError('Game initialization failed. Please refresh the page.');
            }
        }
        
        function setupCharacterFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const nakshatraNum = urlParams.get('nakshatra');
            const pada = urlParams.get('pada');
            const guna1 = urlParams.get('guna1');
            const guna3 = urlParams.get('guna3');
            
            if (nakshatraNum && window.nakshatraData && window.nakshatraData[nakshatraNum]) {
                const nakshatra = window.nakshatraData[nakshatraNum];
                
                // Set up player profile
                window.gameStateManager.playerProfile = {
                    nakshatra: nakshatra.name,
                    gana: nakshatra.gana,
                    shakti: nakshatra.shakti,
                    gunas: nakshatra.gunas || { sattva: 0, rajas: 0, tamas: 0 },
                    avatar: `images/avatars/${nakshatra.gana.toLowerCase()}.png`
                };
                
                // Update character display
                updateCharacterDisplay(nakshatra, nakshatraNum);
                
                console.log(`✓ Character set up: ${nakshatra.name}`);
            } else {
                // Set default character
                window.gameStateManager.playerProfile = {
                    nakshatra: 'Ashwini',
                    gana: 'Deva',
                    shakti: 'To heal quickly',
                    gunas: { sattva: 2, rajas: 1, tamas: 0 },
                    avatar: 'images/avatars/deva.png'
                };
                console.log('✓ Default character set up');
            }
        }
        
        function updateCharacterDisplay(nakshatra, nakshatraNum) {
            // Update character name
            const characterNameEl = document.getElementById('character-name');
            if (characterNameEl) characterNameEl.textContent = nakshatra.name;
            
            // Update character symbol
            const symbolSvg = document.getElementById('character-symbol-svg');
            if (symbolSvg && window.nakshatraSvgPaths && window.nakshatraSvgPaths[nakshatraNum]) {
                symbolSvg.innerHTML = window.nakshatraSvgPaths[nakshatraNum];
            }
            
            // Update element display
            const elementDisplay = document.getElementById('element-display');
            if (elementDisplay && nakshatra.element) {
                const elementIcons = {
                    earth: '<i class="fas fa-mountain"></i>',
                    water: '<i class="fas fa-water"></i>',
                    fire: '<i class="fas fa-fire"></i>',
                    air: '<i class="fas fa-wind"></i>',
                    ether: '<i class="fas fa-star"></i>'
                };
                
                elementDisplay.innerHTML = `
                    <div class="element-icon">${elementIcons[nakshatra.element] || elementIcons.ether}</div>
                    <div class="element-name">${nakshatra.element ? nakshatra.element.charAt(0).toUpperCase() + nakshatra.element.slice(1) : 'Ether'}</div>
                `;
                elementDisplay.className = `element-display element-${nakshatra.element || 'ether'}`;
            }
            
            // Update guna values
            if (nakshatra.gunas) {
                updateGunaDisplay(nakshatra.gunas);
            }
        }
        
        function updateGunaDisplay(gunas) {
            const elements = [
                { id: 'sattva-value', key: 'sattva', fillId: 'sattva-fill' },
                { id: 'rajas-value', key: 'rajas', fillId: 'rajas-fill' },
                { id: 'tamas-value', key: 'tamas', fillId: 'tamas-fill' }
            ];
            
            elements.forEach(({ id, key, fillId }) => {
                const valueEl = document.getElementById(id);
                const fillEl = document.getElementById(fillId);
                const value = gunas[key] || 0;
                
                if (valueEl) valueEl.textContent = value;
                if (fillEl) fillEl.style.width = `${Math.min(100, (value / 3) * 100)}%`;
            });
        }
        
        function initializeStory() {
            // Set initial game state
            window.gameStateManager.playerState.currentAct = 1;
            window.gameStateManager.playerState.currentSceneId = 'JOURNEY_START';
            
            // Render the first scene
            renderCurrentScene();
        }
        
        function renderCurrentScene() {
            try {
                const scene = window.storyEngine.getCurrentScene();
                
                if (!scene) {
                    console.error('No scene found, loading default');
                    loadDefaultScene();
                    return;
                }
                
                console.log('Rendering scene:', window.gameStateManager.playerState.currentSceneId);
                
                // Update story text
                const storyTextEl = document.getElementById('story-text');
                if (storyTextEl && scene.text) {
                    storyTextEl.innerHTML = `<p>${scene.text}</p>`;
                }
                
                // Update puzzle container
                const puzzleEl = document.getElementById('puzzle-container');
                if (puzzleEl) {
                    puzzleEl.innerHTML = '';
                    if (scene.puzzle) {
                        renderPuzzle(scene.puzzle, puzzleEl);
                    }
                }
                
                // Update choices
                const choicesEl = document.getElementById('choices-container');
                if (choicesEl) {
                    renderChoices(choicesEl);
                }
                
                // Update inventory
                updateInventoryDisplay();
                
            } catch (error) {
                console.error('Error rendering scene:', error);
                loadDefaultScene();
            }
        }
        
        function loadDefaultScene() {
            const storyTextEl = document.getElementById('story-text');
            const choicesEl = document.getElementById('choices-container');
            
            if (storyTextEl) {
                storyTextEl.innerHTML = `
                    <h2>Welcome to Samsara Saga</h2>
                    <p>Your consciousness awakens in the village of Dharmapura. The ancient Banyan tree in the center of the village seems to call to you, its gnarled branches reaching toward the sky like hands in prayer.</p>
                    <p>A spiritual malaise hangs in the air, and you sense that your journey has begun...</p>
                `;
            }
            
            if (choicesEl) {
                choicesEl.innerHTML = `
                    <button class="choice-button" onclick="goToScene('DHARMAPURA_SQUARE')">
                        <span class="choice-icon"><i class="fas fa-tree"></i></span>
                        <span class="choice-content">Approach the village square</span>
                    </button>
                    <button class="choice-button" onclick="goToScene('EXAMINE_BANYAN')">
                        <span class="choice-icon"><i class="fas fa-search"></i></span>
                        <span class="choice-content">Examine the ancient Banyan tree</span>
                    </button>
                `;
            }
        }
        
        function renderChoices(container) {
            container.innerHTML = '';
            
            try {
                const choices = window.storyEngine.getAvailableChoices();
                
                if (choices.length === 0) {
                    container.innerHTML = '<p class="no-choices">No choices available. <button onclick="renderCurrentScene()" class="choice-button">Refresh</button></p>';
                    return;
                }
                
                choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-button';
                    button.innerHTML = `
                        <span class="choice-icon"><i class="fas fa-angle-right"></i></span>
                        <span class="choice-content">${choice.text}</span>
                    `;
                    
                    button.addEventListener('click', () => {
                        button.classList.add('choice-selected');
                        processChoice(choice);
                    });
                    
                    container.appendChild(button);
                });
            } catch (error) {
                console.error('Error rendering choices:', error);
                container.innerHTML = `
                    <button class="choice-button" onclick="goToScene('DHARMAPURA_SQUARE')">
                        <span class="choice-icon"><i class="fas fa-forward"></i></span>
                        <span class="choice-content">Continue journey</span>
                    </button>
                `;
            }
        }
        
        function renderPuzzle(puzzle, container) {
            if (!puzzle || !puzzle.puzzleId) return;
            
            const puzzleDiv = document.createElement('div');
            puzzleDiv.className = 'puzzle-container';
            
            const title = document.createElement('h3');
            title.className = 'puzzle-title';
            title.textContent = `Puzzle: ${puzzle.puzzleId}`;
            
            const description = document.createElement('p');
            description.className = 'puzzle-description';
            description.textContent = puzzle.description || 'A challenge awaits...';
            
            puzzleDiv.appendChild(title);
            puzzleDiv.appendChild(description);
            
            // Handle specific puzzles
            if (puzzle.puzzleId === 'BanyanTreeHarmony') {
                renderBanyanPuzzle(puzzleDiv);
            } else if (puzzle.puzzleId === 'BarrierOfNegativity') {
                renderBarrierPuzzle(puzzleDiv);
            }
            
            container.appendChild(puzzleDiv);
        }
        
        function renderBanyanPuzzle(container) {
            const puzzleContent = document.createElement('div');
            puzzleContent.className = 'banyan-puzzle';
            puzzleContent.innerHTML = `
                <p>The ancient Banyan tree's energy is unbalanced. You must harmonize its three spiritual rings:</p>
                <div class="puzzle-rings">
                    <div class="ring" data-ring="vitality">
                        <label>Vitality Ring</label>
                        <input type="range" min="0" max="360" value="0" id="vitality-ring">
                    </div>
                    <div class="ring" data-ring="wisdom">
                        <label>Wisdom Ring</label>
                        <input type="range" min="0" max="360" value="120" id="wisdom-ring">
                    </div>
                    <div class="ring" data-ring="harmony">
                        <label>Harmony Ring</label>
                        <input type="range" min="0" max="360" value="240" id="harmony-ring">
                    </div>
                </div>
                <button class="puzzle-button" onclick="checkBanyanSolution()">Harmonize the Tree</button>
                <div id="puzzle-feedback"></div>
            `;
            container.appendChild(puzzleContent);
        }
        
        function renderBarrierPuzzle(container) {
            const puzzleContent = document.createElement('div');
            puzzleContent.className = 'barrier-puzzle';
            puzzleContent.innerHTML = `
                <p>A barrier of negative energy blocks your path. You need an object of purity to dispel it.</p>
                <div class="barrier-zone" id="barrier-drop-zone">
                    <i class="fas fa-shield-alt"></i>
                    <p>Drop a pure item here</p>
                </div>
                <div class="inventory-items">
                    <h4>Your Items:</h4>
                    <div id="draggable-items"></div>
                </div>
            `;
            
            container.appendChild(puzzleContent);
            setupBarrierPuzzleInteraction();
        }
        
        function setupBarrierPuzzleInteraction() {
            const dropZone = document.getElementById('barrier-drop-zone');
            const itemsContainer = document.getElementById('draggable-items');
            
            // Create draggable items
            const inventory = window.gameStateManager.playerState.inventory || [];
            const hasLotusPetal = window.gameStateManager.worldState.has_lotus_petal;
            
            if (hasLotusPetal) inventory.push('Lotus Petal');
            
            inventory.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'draggable-item';
                itemEl.draggable = true;
                itemEl.textContent = item;
                itemEl.dataset.item = item;
                
                itemEl.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', item);
                });
                
                itemsContainer.appendChild(itemEl);
            });
            
            // Set up drop zone
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                
                const item = e.dataTransfer.getData('text/plain');
                if (item === 'Lotus Petal') {
                    solveBarrierPuzzle();
                } else {
                    showNotification('The barrier repels this item. You need something purer.', 'error');
                }
            });
        }
        
        function processChoice(choice) {
            try {
                if (choice.nextScene) {
                    goToScene(choice.nextScene);
                } else if (choice.id) {
                    const result = window.storyEngine.processChoice(choice.id);
                    if (result) {
                        setTimeout(() => renderCurrentScene(), 300);
                    }
                }
            } catch (error) {
                console.error('Error processing choice:', error);
                showNotification('Error processing choice. Please try again.', 'error');
            }
        }
        
        function goToScene(sceneId) {
            try {
                window.gameStateManager.playerState.currentSceneId = sceneId;
                setTimeout(() => renderCurrentScene(), 300);
            } catch (error) {
                console.error('Error navigating to scene:', error);
                showNotification('Error navigating. Please try again.', 'error');
            }
        }
        
        function checkBanyanSolution() {
            const vitality = document.getElementById('vitality-ring').value;
            const wisdom = document.getElementById('wisdom-ring').value;
            const harmony = document.getElementById('harmony-ring').value;
            
            // Check if rings are aligned (within tolerance)
            const tolerance = 30;
            const isAligned = Math.abs(vitality - 0) < tolerance && 
                             Math.abs(wisdom - 120) < tolerance && 
                             Math.abs(harmony - 240) < tolerance;
            
            const feedback = document.getElementById('puzzle-feedback');
            
            if (isAligned) {
                feedback.innerHTML = '<p class="success">✓ The tree glows with renewed harmony!</p>';
                window.gameStateManager.updateState('banyan_balanced', true);
                showNotification('Puzzle solved! The Banyan tree is harmonized.', 'success');
                setTimeout(() => goToScene('BANYAN_HARMONY_SUCCESS'), 1500);
            } else {
                feedback.innerHTML = '<p class="error">The energies are still unbalanced. Try adjusting the rings.</p>';
            }
        }
        
        function solveBarrierPuzzle() {
            showNotification('The lotus petal dissolves the barrier!', 'success');
            window.gameStateManager.updateState('river_purified', true);
            setTimeout(() => goToScene('PURIFY_CRYSTAL_SUCCESS'), 1500);
        }
        
        function updateInventoryDisplay() {
            const inventoryEl = document.getElementById('inventory-list');
            if (!inventoryEl) return;
            
            const inventory = window.gameStateManager.playerState.inventory || [];
            const hasLotusPetal = window.gameStateManager.worldState.has_lotus_petal;
            
            inventoryEl.innerHTML = '';
            
            if (inventory.length === 0 && !hasLotusPetal) {
                const li = document.createElement('li');
                li.className = 'inventory-empty';
                li.textContent = '(Empty)';
                inventoryEl.appendChild(li);
            } else {
                if (hasLotusPetal) {
                    const li = document.createElement('li');
                    li.textContent = 'Lotus Petal';
                    inventoryEl.appendChild(li);
                }
                
                inventory.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    inventoryEl.appendChild(li);
                });
            }
        }
        
        function setupEventListeners() {
            // Menu button
            const menuButton = document.getElementById('menu-button');
            if (menuButton) {
                menuButton.addEventListener('click', () => {
                    const modal = document.getElementById('game-menu-modal');
                    if (modal) modal.style.display = 'flex';
                });
            }
            
            // Close modal
            const closeModal = document.querySelector('.close-modal');
            if (closeModal) {
                closeModal.addEventListener('click', () => {
                    const modal = document.getElementById('game-menu-modal');
                    if (modal) modal.style.display = 'none';
                });
            }
            
            // New game button
            const newGameBtn = document.getElementById('new-game-btn');
            if (newGameBtn) {
                newGameBtn.addEventListener('click', () => {
                    if (confirm('Start a new journey? Current progress will be lost.')) {
                        window.location.href = 'CB-fixed.html';
                    }
                });
            }
            
            // Save game button
            const saveGameBtn = document.getElementById('save-game-btn');
            if (saveGameBtn) {
                saveGameBtn.addEventListener('click', () => {
                    try {
                        window.gameStateManager.saveGame();
                        showNotification('Game saved successfully!', 'success');
                        document.getElementById('game-menu-modal').style.display = 'none';
                    } catch (error) {
                        showNotification('Failed to save game.', 'error');
                    }
                });
            }
            
            // Custom cursor
            setupCustomCursor();
        }
        
        function setupCustomCursor() {
            if (window.matchMedia('(pointer: fine)').matches) {
                document.body.classList.add('custom-cursor-active');
                const cursorContainer = document.getElementById('cursor-container');
                
                document.addEventListener('mousemove', (e) => {
                    if (cursorContainer) {
                        cursorContainer.style.left = e.clientX + 'px';
                        cursorContainer.style.top = e.clientY + 'px';
                    }
                });
                
                document.addEventListener('mouseover', (e) => {
                    if (e.target.matches('a, button, .choice-button') || 
                        e.target.closest('a, button, .choice-button')) {
                        if (cursorContainer) cursorContainer.classList.add('active');
                    }
                });
                
                document.addEventListener('mouseout', (e) => {
                    if (e.target.matches('a, button, .choice-button') || 
                        e.target.closest('a, button, .choice-button')) {
                        if (cursorContainer) cursorContainer.classList.remove('active');
                    }
                });
            }
        }
        
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            if (!container) return;
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">
                        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    </div>
                    <div class="notification-message">${message}</div>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                notification.classList.add('hide');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        
        function showError(message) {
            const storyTextEl = document.getElementById('story-text');
            const choicesEl = document.getElementById('choices-container');
            
            if (storyTextEl) {
                storyTextEl.innerHTML = `
                    <div class="error-message">
                        <h2>⚠️ Error</h2>
                        <p>${message}</p>
                        <p>Please refresh the page or try again later.</p>
                    </div>
                `;
            }
            
            if (choicesEl) {
                choicesEl.innerHTML = `
                    <button class="choice-button" onclick="window.location.reload()">
                        <span class="choice-icon"><i class="fas fa-refresh"></i></span>
                        <span class="choice-content">Refresh Page</span>
                    </button>
                `;
            }
        }
        
        // Manual initialization function
        function initializeGame() {
            if (!window.gameInitialized) {
                loadAllScripts();
            } else {
                renderCurrentScene();
            }
        }
        
        // Auto-start when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🌟 Samsara Saga - Starting...');
            loadAllScripts();
        });
        
    </script>

    <!-- Embedded Nakshatra Data for fallback -->
    <script>
        // Nakshatra data fallback
        window.nakshatraData = window.nakshatraData || {
            1: { name: 'Ashwini', deity: 'Ashvins', symbol: "Horse's Head", shakti: 'To heal quickly', element: 'fire', gana: 'Deva', gunas: { sattva: 2, rajas: 1, tamas: 0 } },
            2: { name: 'Bharani', deity: 'Yama', symbol: 'Yoni', shakti: 'To renew and purify', element: 'earth', gana: 'Manushya', gunas: { sattva: 0, rajas: 2, tamas: 1 } },
            3: { name: 'Krittika', deity: 'Agni', symbol: 'Knife or Spear', shakti: 'To burn illusion', element: 'fire', gana: 'Rakshasa', gunas: { sattva: 1, rajas: 2, tamas: 0 } },
            4: { name: 'Rohini', deity: 'Brahma', symbol: 'Cart or Chariot', shakti: 'To make things grow', element: 'earth', gana: 'Manushya', gunas: { sattva: 1, rajas: 0, tamas: 2 } },
            5: { name: 'Mrigashira', deity: 'Soma', symbol: "Deer's Head", shakti: 'To find fulfillment', element: 'air', gana: 'Deva', gunas: { sattva: 0, rajas: 1, tamas: 2 } },
            6: { name: 'Ardra', deity: 'Rudra', symbol: 'Teardrop', shakti: 'To feel and act', element: 'water', gana: 'Manushya', gunas: { sattva: 1, rajas: 1, tamas: 1 } },
            7: { name: 'Punarvasu', deity: 'Aditi', symbol: 'Bow and Quiver', shakti: 'To regenerate and recover', element: 'air', gana: 'Deva', gunas: { sattva: 1, rajas: 1, tamas: 1 } },
            8: { name: 'Pushya', deity: 'Brihaspati', symbol: "Cow's Udder", shakti: 'To create spiritual energy', element: 'water', gana: 'Deva', gunas: { sattva: 2, rajas: 0, tamas: 1 } },
            9: { name: 'Ashlesha', deity: 'Nagas', symbol: 'Serpent', shakti: 'To poison and heal', element: 'water', gana: 'Rakshasa', gunas: { sattva: 1, rajas: 1, tamas: 1 } },
            10: { name: 'Magha', deity: 'Pitrs', symbol: 'Royal Throne', shakti: 'To leave the body', element: 'fire', gana: 'Rakshasa', gunas: { sattva: 0, rajas: 2, tamas: 1 } },
            11: { name: 'Purva Phalguni', deity: 'Bhaga', symbol: 'Front Legs of Bed', shakti: 'To find love and enjoyment', element: 'fire', gana: 'Manushya', gunas: { sattva: 0, rajas: 1, tamas: 2 } },
            12: { name: 'Uttara Phalguni', deity: 'Aryaman', symbol: 'Four Legs of Bed', shakti: 'To accumulate security', element: 'fire', gana: 'Manushya', gunas: { sattva: 1, rajas: 0, tamas: 2 } }
        };
        
        // SVG paths for Nakshatra symbols
        window.nakshatraSvgPaths = window.nakshatraSvgPaths || {
            1: '<circle cx="50" cy="50" r="40" stroke="#e09658" stroke-width="2" fill="none"/><path d="M30,30 Q50,10 70,30 Q80,50 70,70 Q50,90 30,70 Q20,50 30,30" stroke="#e09658" stroke-width="2" fill="none"/>',
            2: '<circle cx="50" cy="50" r="40" stroke="#e09658" stroke-width="2" fill="none"/><ellipse cx="50" cy="50" rx="20" ry="30" stroke="#e09658" stroke-width="2" fill="none"/>',
            3: '<circle cx="50" cy="50" r="40" stroke="#e09658" stroke-width="2" fill="none"/><line x1="30" y1="30" x2="70" y2="70" stroke="#e09658" stroke-width="2"/><line x1="30" y1="70" x2="70" y2="30" stroke="#e09658" stroke-width="2"/>',
            4: '<circle cx="50" cy="50" r="40" stroke="#e09658" stroke-width="2" fill="none"/><rect x="30" y="30" width="40" height="40" stroke="#e09658" stroke-width="2" fill="none"/>',
            5: '<circle cx="50" cy="50" r="40" stroke="#e09658" stroke-width="2" fill="none"/><path d="M30,50 Q50,20 70,50 Q50,80 30,50" stroke="#e09658" stroke-width="2" fill="none"/>',
            6: '<circle cx="50" cy="50" r="40" stroke="#e09658" stroke-width="2" fill="none"/><path d="M50,30 Q70,50 50,70 Q30,50 50,30" stroke="#e09658" stroke-width="2" fill="none"/>',
            7: '<circle cx="50" cy="50" r="40" stroke="#e09658" stroke-width="2" fill="none"/><path d="M30,50 L70,50 M50,30 L50,70" stroke="#e09658" stroke-width="2"/>',
            8: '<circle cx="50" cy="50" r="40" stroke="#e09658" stroke-width="2" fill="none"/><circle cx="50" cy="50" r="20" stroke="#e09658" stroke-width="2" fill="none"/>',
            9: '<circle cx="50" cy="50" r="40" stroke="#e09658" stroke-width="2" fill="none"/><path d="M30,70 Q50,30 70,70" stroke="#e09658" stroke-width="2" fill="none"/>',
            10: '<circle cx="50" cy="50" r="40" stroke="#e09658" stroke-width="2" fill="none"/><rect x="35" y="35" width="30" height="30" stroke="#e09658" stroke-width="2" fill="none"/>',
            11: '<circle cx="50" cy="50" r="40" stroke="#e09658" stroke-width="2" fill="none"/><line x1="30" y1="70" x2="70" y2="70" stroke="#e09658" stroke-width="2"/><line x1="30" y1="70" x2="30" y2="30" stroke="#e09658" stroke-width="2"/><line x1="70" y1="70" x2="70" y2="30" stroke="#e09658" stroke-width="2"/>',
            12: '<circle cx="50" cy="50" r="40" stroke="#e09658" stroke-width="2" fill="none"/><rect x="30" y="30" width="40" height="40" stroke="#e09658" stroke-width="2" fill="none"/>'
        };
    </script>

    <!-- Inline styles for better appearance -->
    <style>
        /* --- Core Game Styles --- */
        :root {
            --font-title: 'Cinzel', serif;
            --font-body: 'Marcellus', serif;
            
            --color-bg: #0a0908;
            --color-surface: #1a1817;
            --color-text: #c5c1b9;
            --color-text-muted: #7a7670;
            
            --color-primary: #e09658;
            --color-primary-glow: #ffc994;
            --color-shadow: #e09658;

            --color-sattva: #63b4d1;
            --color-rajas: #d96c47;
            --color-tamas: #5c527f;
            --color-karma: #bca06a;

            --border-radius: 8px;
            --transition-speed: 0.3s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--color-bg);
            color: var(--color-text);
            overflow: hidden;
            cursor: none;
        }
        
        /* Custom Cursor */
        .custom-cursor-active {
            cursor: none;
        }
        #cursor-container {
            position: fixed;
            left: 0;
            top: 0;
            pointer-events: none;
            z-index: 9999;
            transition: transform 0.1s ease-out;
        }
        #cursor-container .chakra-cursor {
            transition: all 0.2s ease;
            transform-origin: center center;
        }
        #cursor-container.active .chakra-cursor {
            transform: scale(1.5);
            filter: drop-shadow(0 0 5px var(--color-primary-glow));
        }
        @media (pointer: coarse) {
            body, .custom-cursor-active {
                cursor: auto;
            }
            #cursor-container {
                display: none;
            }
        }

        /* Animated Background */
        #particle-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(circle, rgba(224, 150, 88, 0.05) 1px, transparent 1px);
            background-size: 2rem 2rem;
            animation: pan-background 120s linear infinite;
            z-index: -2;
        }
        @keyframes pan-background {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }
        #vignette-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: inset 0 0 15vw 5vw var(--color-bg);
            pointer-events: none;
            z-index: -1;
        }
        
        /* Page Transitions */
        .page-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--color-bg);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .page-transition.active {
            opacity: 1;
            pointer-events: all;
        }
        .page-transition-mandala {
            width: 100px;
            height: 100px;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='50' cy='50' r='45' stroke='%23e09658' stroke-width='1' fill='none'/%3E%3Ccircle cx='50' cy='50' r='30' stroke='%23e09658' stroke-width='1' fill='none'/%3E%3Ccircle cx='50' cy='50' r='15' stroke='%23e09658' stroke-width='1' fill='none'/%3E%3Ccircle cx='50' cy='50' r='5' fill='%23e09658'/%3E%3C/svg%3E");
            animation: spin 2s linear infinite, pulse-glow 2s ease-in-out infinite;
        }

        /* Game Layout */
        .game-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 1rem 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(to bottom, rgba(10, 9, 8, 0.8) 0%, rgba(10, 9, 8, 0) 100%);
            z-index: 50;
        }
        .header-title {
            font-family: var(--font-title);
            font-size: 2.5rem;
            color: var(--color-primary);
            text-shadow: 0 0 10px var(--color-shadow);
        }
        .menu-toggle-button {
            position: absolute;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
        }
        .game-wrapper {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            padding: 8rem 2rem 2rem;
            height: 100vh;
        }
        .story-panel, .status-panel {
            background: rgba(26, 24, 23, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(224, 150, 88, 0.2);
            border-radius: var(--border-radius);
            padding: 2rem;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(224, 150, 88, 0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-primary); }

        /* Story Panel */
        #story-text {
            font-size: 1.2rem;
            line-height: 1.8;
            margin-bottom: 2rem;
        }
        #story-text p { margin-bottom: 1.5rem; }
        .highlight-text {
            color: var(--color-primary-glow);
            font-weight: bold;
            text-shadow: 0 0 5px var(--color-shadow);
        }

        /* Choice Buttons */
        #choices-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .choice-button {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            background: transparent;
            border: none;
            border-image: linear-gradient(to right, transparent, rgba(224, 150, 88, 0.3), transparent) 1;
            border-bottom: 1px solid;
            color: var(--color-text);
            padding: 1.25rem 1rem;
            text-align: left;
            font-family: var(--font-body);
            font-size: 1.1rem;
            transition: all var(--transition-speed) ease;
            position: relative;
            overflow: hidden;
            cursor: none;
        }
        .choice-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(224, 150, 88, 0.2), transparent);
            transition: left var(--transition-speed) ease-in-out;
        }
        .choice-button:hover {
            color: var(--color-primary-glow);
            transform: scale(1.02);
            border-image: linear-gradient(to right, transparent, var(--color-primary), transparent) 1;
        }
        .choice-button:hover::before {
            left: 100%;
        }
        .choice-icon {
            font-size: 1.5rem;
            color: var(--color-primary);
            transition: transform var(--transition-speed) ease;
        }
        .choice-button:hover .choice-icon {
            transform: scale(1.2) rotate(-5deg);
        }
        .choice-button.choice-selected {
            background-color: rgba(224, 150, 88, 0.2);
            animation: pulse-glow 0.5s ease-out;
        }

        /* Status Panel */
        .status-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .panel-section {
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(224, 150, 88, 0.1);
        }
        .panel-section:last-child { border-bottom: none; }
        .panel-title {
            font-family: var(--font-title);
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--color-primary);
            margin-bottom: 1rem;
            text-align: center;
        }
        .character-summary {
            text-align: center;
        }
        .character-symbol {
            width: 100px;
            height: 100px;
            margin: 0 auto 1rem;
            filter: drop-shadow(0 0 15px var(--color-shadow));
            animation: float 4s ease-in-out infinite;
        }
        .character-name {
            font-family: var(--font-title);
            font-size: 2.2rem;
            color: var(--color-primary-glow);
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            gap: 1rem;
        }
        .stat-item {
            display: grid;
            grid-template-columns: 60px 1fr 30px;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }
        .stat-label { color: var(--color-text-muted); }
        .stat-value { text-align: right; font-weight: bold; }
        .stat-bar {
            height: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            overflow: hidden;
        }
        .stat-bar > div {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
        .karma-bar > div { background: linear-gradient(90deg, var(--color-karma), #d9c69a); }
        .sattva-bar > div { background: linear-gradient(90deg, var(--color-sattva), #9fd2e4); }
        .rajas-bar > div { background: linear-gradient(90deg, var(--color-rajas), #f09b7c); }
        .tamas-bar > div { background: linear-gradient(90deg, var(--color-tamas), #8a80a8); }

        /* Element Display */
        .element-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            text-transform: capitalize;
        }
        .element-icon { font-size: 2.5rem; }
        .element-earth { color: #8c6a46; }
        .element-water { color: #5c8b9c; }
        .element-fire { color: #d96c47; }
        .element-air { color: #a9b7c0; }
        .element-ether { color: #8c6da6; }

        /* Inventory */
        #inventory-list {
            list-style: none;
            text-align: center;
            min-height: 50px;
        }
        .inventory-empty { color: var(--color-text-muted); font-style: italic; }

        /* Buttons */
        button {
            cursor: none;
        }
        .control-button, .menu-toggle-button, .menu-button {
            background: linear-gradient(to bottom, rgba(255,255,255,0.05), rgba(0,0,0,0.05));
            border: 1px solid rgba(224, 150, 88, 0.5);
            color: var(--color-text);
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-family: var(--font-title);
            font-size: 1rem;
            letter-spacing: 1px;
            transition: all var(--transition-speed) ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
        }
        .control-button:hover, .menu-toggle-button:hover, .menu-button:hover {
            background-color: rgba(224, 150, 88, 0.1);
            color: var(--color-primary-glow);
            border-color: var(--color-primary);
            box-shadow: 0 0 15px 0 var(--color-shadow);
            transform: translateY(-2px);
        }
        .control-button { width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }

        /* Modal */
        .modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(10, 9, 8, 0.8);
            backdrop-filter: blur(5px);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: var(--color-surface);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 50px rgba(0,0,0,0.7);
            animation: fadeInUp 0.5s ease-out;
        }
        .modal-header {
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(224, 150, 88, 0.3);
        }
        .modal-header h2 {
            font-family: var(--font-title);
            font-size: 2rem;
            color: var(--color-primary);
        }
        .close-modal {
            color: var(--color-text-muted);
            font-size: 2rem;
            transition: color 0.3s ease;
            cursor: none;
        }
        .close-modal:hover { color: var(--color-primary-glow); }
        .modal-body { padding: 1.5rem; }
        .menu-buttons { display: flex; flex-direction: column; gap: 1rem; }
        .menu-button { display: flex; align-items: center; gap: 1rem; width: 100%; }
        .menu-button i { color: var(--color-primary); min-width: 20px; }

        /* Notifications */
        #notification-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 1000;
            display: flex; flex-direction: column; gap: 10px;
        }
        .notification {
            background: linear-gradient(135deg, var(--color-surface), #2a2725);
            border-left: 4px solid var(--color-primary);
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            transform: translateX(120%);
            opacity: 0;
            transition: transform 0.5s ease, opacity 0.5s ease;
            min-width: 300px;
        }
        .notification.show { transform: translateX(0); opacity: 1; }
        .notification.hide { transform: translateX(120%); opacity: 0; }
        .notification.success { border-left-color: var(--color-sattva); }
        .notification.error { border-left-color: var(--color-rajas); }
        .notification-content { display: flex; align-items: center; gap: 1rem; }
        .notification-icon { font-size: 1.5rem; }
        .notification.success .notification-icon { color: var(--color-sattva); }
        .notification.error .notification-icon { color: var(--color-rajas); }

        /* Puzzle Styles */
        .puzzle-container {
            background: rgba(224, 150, 88, 0.1);
            border: 1px solid rgba(224, 150, 88, 0.3);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin: 1rem 0;
        }
        .puzzle-title {
            color: var(--color-primary);
            margin-bottom: 1rem;
            text-align: center;
        }
        .puzzle-description {
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .puzzle-rings {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 1.5rem 0;
        }
        .ring {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .ring label {
            font-weight: bold;
            color: var(--color-primary);
        }
        .ring input[type="range"] {
            width: 100%;
            height: 6px;
            background: rgba(224, 150, 88, 0.2);
            outline: none;
            border-radius: 3px;
        }
        .puzzle-button {
            background: var(--color-primary);
            color: var(--color-bg);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-weight: bold;
            width: 100%;
            transition: all 0.3s ease;
        }
        .puzzle-button:hover {
            background: var(--color-primary-glow);
            transform: translateY(-2px);
        }
        .barrier-puzzle {
            text-align: center;
        }
        .barrier-zone {
            background: rgba(92, 82, 127, 0.2);
            border: 2px dashed rgba(92, 82, 127, 0.5);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin: 1rem 0;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .barrier-zone.drag-over {
            background: rgba(224, 150, 88, 0.2);
            border-color: var(--color-primary);
        }
        .draggable-item {
            background: rgba(224, 150, 88, 0.3);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            display: inline-block;
            cursor: grab;
        }
        .draggable-item:active {
            cursor: grabbing;
        }
        #puzzle-feedback .success {
            color: var(--color-sattva);
            font-weight: bold;
        }
        #puzzle-feedback .error {
            color: var(--color-rajas);
        }

        /* Animations */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulse-glow { 0%, 100% { filter: drop-shadow(0 0 10px var(--color-shadow)); } 50% { filter: drop-shadow(0 0 20px var(--color-primary-glow)); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translate3d(0, 40px, 0); } to { opacity: 1; transform: translate3d(0, 0, 0); } }
        .text-fade-in { animation: fadeInUp 0.8s ease-out; }
        .text-fade-in-delay-1 { animation: fadeInUp 0.8s ease-out 0.4s; animation-fill-mode: backwards; }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .game-wrapper {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
                padding: 6rem 1rem 1rem;
            }
            .status-panel {
                grid-row: 1;
            }
            .story-panel {
                grid-row: 2;
            }
        }
        @media (max-width: 768px) {
            .header-title { font-size: 1.8rem; }
            .menu-toggle-button { right: 1rem; }
            .game-wrapper { gap: 1rem; }
            .story-panel, .status-panel { padding: 1.5rem; }
            #story-text { font-size: 1.1rem; }
            .choice-button { font-size: 1rem; padding: 1rem; gap: 1rem; }
        }

        /* Error styles */
        .error-message {
            text-align: center;
            padding: 2rem;
            background: rgba(217, 108, 71, 0.1);
            border: 1px solid rgba(217, 108, 71, 0.3);
            border-radius: var(--border-radius);
        }
        .error-message h2 {
            color: var(--color-rajas);
            margin-bottom: 1rem;
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Skip link for accessibility */
        .skip-link { 
            position: fixed; 
            left: -9999px; 
            top: 0; 
            background: var(--color-primary); 
            color: #0a0908; 
            padding: 8px 12px; 
            border-radius: 6px; 
            z-index: 10001; 
        }
        .skip-link:focus { 
            left: 10px; 
            top: 10px; 
            box-shadow: 0 0 10px var(--color-primary-glow); 
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * { 
                animation-duration: 0.001s !important; 
                animation-iteration-count: 1 !important; 
                transition: none !important; 
            }
            .page-transition-mandala { animation: none !important; }
            #particle-background { animation: none !important; }
        }
    </style>
</body>
</html>
