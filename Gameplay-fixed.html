<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Samsara Saga - Master's Journey</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Marcellus&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --font-title: 'Cinzel', serif;
            --font-body: 'Marcellus', serif;
            
            --color-bg: #0a0908;
            --color-surface: #1a1817;
            --color-text: #c5c1b9;
            --color-text-muted: #7a7670;
            
            --color-primary: #e09658;
            --color-primary-glow: #ffc994;
            --color-shadow: #e09658;

            --color-sattva: #63b4d1;
            --color-rajas: #d96c47;
            --color-tamas: #5c527f;
            --color-karma: #bca06a;

            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-info: #3b82f6;
            --color-cosmic: #8b5cf6;

            --border-radius: 12px;
            --transition-speed: 0.4s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: radial-gradient(ellipse at center, #1a1817 0%, var(--color-bg) 70%);
            color: var(--color-text);
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        /* Cosmic Background Animation */
        .cosmic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .stars {
            position: absolute;
            width: 200%;
            height: 200%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, rgba(224, 150, 88, 0.3), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(99, 180, 209, 0.3), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(168, 139, 250, 0.3), transparent),
                radial-gradient(1px 1px at 130px 80px, rgba(224, 150, 88, 0.2), transparent),
                radial-gradient(2px 2px at 160px 30px, rgba(92, 82, 127, 0.3), transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: cosmic-drift 300s linear infinite;
        }

        @keyframes cosmic-drift {
            from { transform: translateY(0px); }
            to { transform: translateY(-100px); }
        }

        .energy-field {
            position: absolute;
            width: 100%;
            height: 100%;
            background: conic-gradient(
                from 0deg at 50% 50%,
                transparent 0deg,
                rgba(224, 150, 88, 0.02) 60deg,
                transparent 120deg,
                rgba(99, 180, 209, 0.02) 180deg,
                transparent 240deg,
                rgba(168, 139, 250, 0.02) 300deg,
                transparent 360deg
            );
            animation: field-rotation 200s linear infinite;
        }

        @keyframes field-rotation {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Header */
        .game-header {
            background: linear-gradient(135deg, rgba(26, 24, 23, 0.95) 0%, rgba(10, 9, 8, 0.95) 100%);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid rgba(224, 150, 88, 0.3);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .header-title {
            font-family: var(--font-title);
            font-size: 3rem;
            background: linear-gradient(45deg, var(--color-primary), var(--color-primary-glow), var(--color-cosmic));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px var(--color-shadow);
            animation: title-glow 3s ease-in-out infinite alternate;
        }

        @keyframes title-glow {
            from { filter: drop-shadow(0 0 10px rgba(224, 150, 88, 0.5)); }
            to { filter: drop-shadow(0 0 20px rgba(224, 150, 88, 0.8)); }
        }

        .master-badge {
            background: linear-gradient(45deg, var(--color-cosmic), var(--color-primary));
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: badge-pulse 2s ease-in-out infinite;
        }

        @keyframes badge-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Main Layout */
        .game-container {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 2rem;
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
            min-height: calc(100vh - 120px);
        }

        .main-panel {
            background: rgba(26, 24, 23, 0.8);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(224, 150, 88, 0.3);
            border-radius: var(--border-radius);
            padding: 2.5rem;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            max-height: calc(100vh - 180px);
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .panel {
            background: rgba(26, 24, 23, 0.85);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(224, 150, 88, 0.25);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        .panel-title {
            font-family: var(--font-title);
            color: var(--color-primary);
            font-size: 1.4rem;
            margin-bottom: 1rem;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid rgba(224, 150, 88, 0.2);
            padding-bottom: 0.5rem;
        }

        /* Character Display */
        .character-display {
            text-align: center;
        }

        .character-symbol {
            width: 120px;
            height: 120px;
            margin: 0 auto 1rem;
            border: 3px solid var(--color-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle, rgba(224, 150, 88, 0.15) 0%, transparent 70%);
            animation: symbol-rotate 20s linear infinite;
            position: relative;
        }

        .character-symbol::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border: 1px solid rgba(224, 150, 88, 0.3);
            border-radius: 50%;
            animation: pulse-ring 3s ease-in-out infinite;
        }

        @keyframes symbol-rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse-ring {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .character-name {
            font-family: var(--font-title);
            font-size: 2rem;
            color: var(--color-primary-glow);
            margin-bottom: 0.5rem;
        }

        .character-gana {
            color: var(--color-text-muted);
            font-style: italic;
            margin-bottom: 1rem;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            gap: 1rem;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border-left: 4px solid var(--color-primary);
        }

        .stat-label {
            font-weight: bold;
            color: var(--color-text);
        }

        .stat-value {
            color: var(--color-primary);
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* Master Puzzle Container */
        .master-puzzle-container {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(224, 150, 88, 0.1) 100%);
            border: 3px solid rgba(139, 92, 246, 0.4);
            border-radius: 20px;
            padding: 3rem;
            margin: 2rem 0;
            position: relative;
            overflow: hidden;
        }

        .master-puzzle-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                from 0deg,
                transparent,
                rgba(139, 92, 246, 0.1),
                transparent 120deg,
                rgba(224, 150, 88, 0.1) 180deg,
                transparent 240deg,
                rgba(99, 180, 209, 0.1) 300deg,
                transparent
            );
            animation: puzzle-aura 30s linear infinite;
            z-index: -1;
        }

        @keyframes puzzle-aura {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .puzzle-title {
            font-family: var(--font-title);
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, var(--color-cosmic), var(--color-primary));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
        }

        .puzzle-description {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 2rem;
            line-height: 1.6;
            color: var(--color-text);
        }

        /* Multi-Stage Progress */
        .stage-progress {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
        }

        .stage-indicator {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid rgba(224, 150, 88, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            position: relative;
            transition: all 0.5s ease;
        }

        .stage-indicator.completed {
            background: var(--color-success);
            border-color: var(--color-success);
            color: white;
        }

        .stage-indicator.active {
            background: var(--color-cosmic);
            border-color: var(--color-cosmic);
            color: white;
            animation: active-pulse 2s ease-in-out infinite;
        }

        .stage-indicator.locked {
            background: rgba(122, 118, 112, 0.3);
            border-color: var(--color-text-muted);
            color: var(--color-text-muted);
        }

        @keyframes active-pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.5); }
            50% { box-shadow: 0 0 40px rgba(139, 92, 246, 0.8); }
        }

        /* Stage Content */
        .puzzle-stage {
            display: none;
            animation: stage-fade-in 0.8s ease-out;
        }

        .puzzle-stage.active {
            display: block;
        }

        @keyframes stage-fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stage-title {
            font-family: var(--font-title);
            font-size: 1.8rem;
            color: var(--color-primary);
            margin-bottom: 1rem;
            text-align: center;
        }

        .stage-description {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        /* Banyan Tree Harmonic Resonance Puzzle */
        .harmonic-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            margin: 2rem 0;
        }

        .resonance-chamber {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(224, 150, 88, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .chamber-title {
            font-weight: bold;
            color: var(--color-primary);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .frequency-wheel {
            width: 120px;
            height: 120px;
            margin: 0 auto 1rem;
            border: 3px solid var(--color-primary);
            border-radius: 50%;
            position: relative;
            background: radial-gradient(circle, rgba(224, 150, 88, 0.1) 0%, transparent 70%);
            cursor: pointer;
        }

        .frequency-marker {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--color-cosmic);
            border-radius: 50%;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            transition: transform 0.3s ease;
        }

        .frequency-control {
            width: 100%;
            margin: 1rem 0;
        }

        .frequency-slider {
            width: 100%;
            -webkit-appearance: none;
            height: 8px;
            background: rgba(224, 150, 88, 0.2);
            border-radius: 4px;
            outline: none;
        }

        .frequency-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--color-cosmic);
            border-radius: 50%;
            cursor: pointer;
        }

        .harmonic-display {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--color-text);
        }

        /* Sacred Geometry Pattern Puzzle */
        .geometry-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            max-width: 500px;
            margin: 2rem auto;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 2px solid rgba(139, 92, 246, 0.3);
        }

        .geometry-node {
            width: 50px;
            height: 50px;
            border: 2px solid rgba(224, 150, 88, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(26, 24, 23, 0.6);
            font-size: 1.5rem;
            position: relative;
        }

        .geometry-node:hover {
            border-color: var(--color-cosmic);
            background: rgba(139, 92, 246, 0.2);
            transform: scale(1.1);
        }

        .geometry-node.activated {
            background: var(--color-cosmic);
            color: white;
            border-color: var(--color-cosmic);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.6);
        }

        .geometry-node.correct {
            background: var(--color-success);
            border-color: var(--color-success);
            animation: correct-flash 1s ease-out;
        }

        .geometry-node.incorrect {
            background: var(--color-danger);
            border-color: var(--color-danger);
            animation: shake 0.5s ease-out;
        }

        @keyframes correct-flash {
            0%, 100% { box-shadow: 0 0 15px rgba(16, 185, 129, 0.6); }
            50% { box-shadow: 0 0 30px rgba(16, 185, 129, 1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Chakra Meditation Master Puzzle */
        .chakra-mandala {
            width: 400px;
            height: 400px;
            margin: 2rem auto;
            position: relative;
            border: 3px solid var(--color-cosmic);
            border-radius: 50%;
            background: radial-gradient(
                circle,
                rgba(139, 92, 246, 0.1) 0%,
                rgba(224, 150, 88, 0.1) 50%,
                transparent 100%
            );
        }

        .chakra-point {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s ease;
            font-size: 1.8rem;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
        }

        .chakra-point:hover {
            transform: scale(1.2);
            box-shadow: 0 0 25px currentColor;
        }

        .chakra-point.activated {
            animation: chakra-awakening 2s ease-in-out infinite;
            transform: scale(1.1);
        }

        @keyframes chakra-awakening {
            0%, 100% { box-shadow: 0 0 20px currentColor; }
            50% { box-shadow: 0 0 40px currentColor; }
        }

        /* Sequence Display */
        .sequence-display {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .sequence-step {
            width: 50px;
            height: 50px;
            border: 2px solid rgba(224, 150, 88, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .sequence-step.completed {
            background: var(--color-success);
            border-color: var(--color-success);
            color: white;
        }

        .sequence-step.active {
            background: var(--color-cosmic);
            border-color: var(--color-cosmic);
            color: white;
            animation: sequence-pulse 1s ease-in-out infinite;
        }

        @keyframes sequence-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Controls */
        .puzzle-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 3rem 0;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-family: var(--font-title);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            min-width: 120px;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-cosmic), #a855f7);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-glow));
            color: var(--color-bg);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--color-danger), #fca5a5);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--color-info), #60a5fa);
            color: white;
        }

        /* Feedback System */
        .feedback-container {
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2rem 0;
        }

        .feedback-message {
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
            max-width: 600px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

        .feedback-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .feedback-success {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid var(--color-success);
            color: var(--color-success);
        }

        .feedback-error {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid var(--color-danger);
            color: var(--color-danger);
        }

        .feedback-hint {
            background: rgba(139, 92, 246, 0.2);
            border: 2px solid var(--color-cosmic);
            color: var(--color-cosmic);
        }

        .feedback-warning {
            background: rgba(245, 158, 11, 0.2);
            border: 2px solid var(--color-warning);
            color: var(--color-warning);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .game-container {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .harmonic-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .geometry-grid {
                grid-template-columns: repeat(5, 1fr);
                max-width: 400px;
            }

            .chakra-mandala {
                width: 300px;
                height: 300px;
            }
        }

        @media (max-width: 768px) {
            .header-title {
                font-size: 2rem;
            }

            .game-container {
                padding: 1rem;
            }

            .main-panel {
                padding: 1.5rem;
            }

            .geometry-grid {
                grid-template-columns: repeat(4, 1fr);
                max-width: 300px;
            }

            .geometry-node {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }

            .chakra-mandala {
                width: 250px;
                height: 250px;
            }

            .chakra-point {
                width: 45px;
                height: 45px;
                font-size: 1.4rem;
            }

            .puzzle-controls {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Notification System */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            background: rgba(26, 24, 23, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid var(--color-primary);
            border-radius: 10px;
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.5s ease;
            min-width: 320px;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notification-icon {
            font-size: 1.5rem;
            color: var(--color-primary);
        }

        .notification.success {
            border-color: var(--color-success);
        }

        .notification.success .notification-icon {
            color: var(--color-success);
        }

        .notification.error {
            border-color: var(--color-danger);
        }

        .notification.error .notification-icon {
            color: var(--color-danger);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(224, 150, 88, 0.1);
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--color-primary), var(--color-cosmic));
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--color-primary-glow), #a855f7);
        }
    </style>
</head>
<body>
    <!-- Cosmic Background -->
    <div class="cosmic-bg">
        <div class="stars"></div>
        <div class="energy-field"></div>
    </div>

    <!-- Header -->
    <header class="game-header">
        <h1 class="header-title">Samsara Saga</h1>
        <div class="master-badge">🌟 Master's Trial</div>
    </header>

    <!-- Main Container -->
    <div class="game-container">
        <!-- Main Panel -->
        <main class="main-panel">
            <!-- Story Content -->
            <div style="margin-bottom: 2rem;">
                <h2 style="font-family: var(--font-title); font-size: 2.5rem; color: var(--color-primary-glow); text-align: center; margin-bottom: 1rem;">
                    The Great Banyan's Ultimate Trial
                </h2>
                <p style="font-size: 1.3rem; line-height: 1.6; text-align: center; margin-bottom: 1.5rem;">
                    The ancient Banyan tree stands before you, its massive form pulsing with cosmic energy. This is no ordinary challenge—you must master three profound stages of spiritual alignment to unlock the tree's deepest wisdom.
                </p>
                <p style="font-size: 1.1rem; line-height: 1.6; text-align: center; color: var(--color-text-muted);">
                    Only those who understand the deepest mysteries of harmonic resonance, sacred geometry, and chakra awakening can hope to succeed.
                </p>
            </div>

            <!-- Master Puzzle Container -->
            <div class="master-puzzle-container">
                <h3 class="puzzle-title">🌳 The Banyan's Trinity Challenge</h3>
                <p class="puzzle-description">
                    Three sacred trials await. Each stage builds upon the last, testing your mastery of ancient wisdom.
                    Failure at any stage requires starting from the beginning.
                </p>

                <!-- Stage Progress -->
                <div class="stage-progress">
                    <div class="stage-indicator active" data-stage="1">
                        <span>1</span>
                    </div>
                    <div class="stage-indicator locked" data-stage="2">
                        <span>2</span>
                    </div>
                    <div class="stage-indicator locked" data-stage="3">
                        <span>3</span>
                    </div>
                </div>

                <!-- Stage 1: Harmonic Resonance -->
                <div class="puzzle-stage active" id="stage-1">
                    <h4 class="stage-title">Stage 1: Harmonic Resonance Mastery</h4>
                    <p class="stage-description">
                        The Banyan's three root systems vibrate at different frequencies. You must tune each harmonic chamber to achieve perfect resonance. The frequencies must form a sacred mathematical relationship.
                    </p>

                    <div class="harmonic-grid">
                        <div class="resonance-chamber">
                            <div class="chamber-title">Sattva Resonance</div>
                            <div class="frequency-wheel" id="wheel-1">
                            <div class="frequency-marker" id="marker-1"></div>
                        </div>
                            <div class="frequency-control">
                                <input type="range" min="0" max="360" value="0" class="frequency-slider" id="freq-1" onchange="updateFrequency(1)">
                            </div>
                            <div class="harmonic-display" id="display-1">432 Hz</div>
                        </div>

                        <div class="resonance-chamber">
                            <div class="chamber-title">Rajas Resonance</div>
                            <div class="frequency-wheel" id="wheel-2">
                            <div class="frequency-marker" id="marker-2"></div>
                        </div>
                            <div class="frequency-control">
                                <input type="range" min="0" max="360" value="120" class="frequency-slider" id="freq-2" onchange="updateFrequency(2)">
                            </div>
                            <div class="harmonic-display" id="display-2">528 Hz</div>
                        </div>

                        <div class="resonance-chamber">
                            <div class="chamber-title">Tamas Resonance</div>
                            <div class="frequency-wheel" id="wheel-3">
                            <div class="frequency-marker" id="marker-3"></div>
                        </div>
                            <div class="frequency-control">
                                <input type="range" min="0" max="360" value="240" class="frequency-slider" id="freq-3" onchange="updateFrequency(3)">
                            </div>
                            <div class="harmonic-display" id="display-3">639 Hz</div>
                        </div>
                    </div>

                    <div style="text-align: center; margin: 1.5rem 0;">
                        <div style="font-weight: bold; color: var(--color-cosmic); margin-bottom: 0.5rem;">
                            Target Harmonic Ratio: 3:4:5 (Perfect Sacred Triad)
                        </div>
                        <div style="color: var(--color-text-muted); font-size: 0.9rem;">
                            Hint: The frequencies must align at precise mathematical intervals
                        </div>
                    </div>
                </div>

                <!-- Stage 2: Sacred Geometry -->
                <div class="puzzle-stage" id="stage-2">
                    <h4 class="stage-title">Stage 2: Sacred Geometry Activation</h4>
                    <p class="stage-description">
                        Activate the nodes in the correct sequence to form the Flower of Life pattern. Each activation affects neighboring nodes. The pattern must be completed in a specific order to unlock the tree's geometric consciousness.
                    </p>

                    <div class="geometry-grid" id="geometry-grid">
                        <!-- Nodes will be generated by JavaScript -->
                    </div>

                    <div style="text-align: center; margin: 1.5rem 0;">
                        <div style="font-weight: bold; color: var(--color-cosmic); margin-bottom: 0.5rem;">
                            Sequence Required: Flower of Life Manifestation
                        </div>
                        <div style="color: var(--color-text-muted); font-size: 0.9rem;">
                            Follow the sacred sequence: Center → Petals → Overlapping Circles
                        </div>
                    </div>
                </div>

                <!-- Stage 3: Chakra Awakening -->
                <div class="puzzle-stage" id="stage-3">
                    <h4 class="stage-title">Stage 3: Master Chakra Awakening</h4>
                    <p class="stage-description">
                        Awaken all seven chakras in the correct order while maintaining perfect timing. Each chakra must be activated at the precise moment in the cosmic cycle. A single mistimed activation will reset the entire sequence.
                    </p>

                    <div class="chakra-mandala" id="chakra-mandala">
                        <!-- Chakras will be positioned by JavaScript -->
                    </div>

                    <div class="sequence-display" id="chakra-sequence">
                        <!-- Sequence steps will be generated by JavaScript -->
                    </div>

                    <div style="text-align: center; margin: 1.5rem 0;">
                        <div style="font-weight: bold; color: var(--color-cosmic); margin-bottom: 0.5rem;">
                            Cosmic Timing Window: 3 seconds per activation
                        </div>
                        <div style="color: var(--color-text-muted); font-size: 0.9rem;">
                            Wait for the cosmic pulse before each activation
                        </div>
                    </div>
                </div>

                <!-- Feedback Container -->
                <div class="feedback-container">
                    <div class="feedback-message" id="feedback-message"></div>
                </div>

                <!-- Controls -->
                <div class="puzzle-controls">
                    <button class="control-btn btn-primary" onclick="checkCurrentStage()">
                        Validate Stage
                    </button>
                    <button class="control-btn btn-info" onclick="getStageHint()">
                        Cosmic Guidance
                    </button>
                    <button class="control-btn btn-danger" onclick="resetCurrentStage()">
                        Reset Stage
                    </button>
                    <button class="control-btn btn-secondary" onclick="skipToNextQuest()">
                        Continue Journey
                    </button>
                </div>
            </div>
        </main>

        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Character Panel -->
            <div class="panel">
                <h3 class="panel-title">Character</h3>
                <div class="character-display">
                    <div class="character-symbol">
                        <svg viewBox="0 0 100 100" width="90" height="90">
                            <rect x="30" y="30" width="40" height="40" stroke="#e09658" stroke-width="3" fill="none"/>
                            <circle cx="50" cy="50" r="35" stroke="#e09658" stroke-width="2" fill="none" opacity="0.6"/>
                        </svg>
                    </div>
                    <div class="character-name" id="character-name">Uttara Phalguni</div>
                    <div class="character-gana" id="character-gana">Manushya Gana</div>
                </div>
            </div>

            <!-- Progress Panel -->
            <div class="panel">
                <h3 class="panel-title">Master's Progress</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">Karma</span>
                        <span class="stat-value" id="karma-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Mastery Level</span>
                        <span class="stat-value" id="mastery-level">Novice</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Trials Completed</span>
                        <span class="stat-value" id="trials-completed">0/3</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Wisdom Gained</span>
                        <span class="stat-value" id="wisdom-gained">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Cosmic Attunement</span>
                        <span class="stat-value" id="attunement">12%</span>
                    </div>
                </div>
            </div>

            <!-- Sacred Items -->
            <div class="panel">
                <h3 class="panel-title">Sacred Artifacts</h3>
                <div id="artifacts-list" style="text-align: center; color: var(--color-text-muted); font-style: italic;">
                    Complete trials to unlock sacred artifacts...
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="panel">
                <h3 class="panel-title">Master's Tools</h3>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <button class="control-btn btn-secondary" onclick="saveProgress()" style="width: 100%;">
                        💾 Save Progress
                    </button>
                    <button class="control-btn btn-info" onclick="viewGrandDesign()" style="width: 100%;">
                        🔮 View Grand Design
                    </button>
                    <button class="control-btn btn-primary" onclick="enterMeditation()" style="width: 100%;">
                        🧘 Deep Meditation
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notification-container"></div>

    <!-- Story Data Scripts -->
    <script src="ACT1storyData.js"></script>
    <script src="ACT2storyData.js"></script>
    <script src="ACT3storyData.js"></script>
    <script src="StoryEngine.js"></script>

    <script>
        // ===== COMPREHENSIVE GAME STATE MANAGEMENT =====
        class MasterGameState {
            constructor() {
                this.currentStage = 1;
                this.completedStages = [];
                this.playerStats = {
                    karma: 0,
                    masteryLevel: 'Novice',
                    trialsCompleted: 0,
                    wisdomGained: 0,
                    attunement: 12
                };
                
                // Stage 1: Harmonic Resonance
                this.harmonics = {
                    freq1: 0,    // Target: 108 (sacred number)
                    freq2: 120,  // Target: 144 (108 * 4/3)
                    freq3: 240   // Target: 180 (108 * 5/3)
                };
                
                // Stage 2: Sacred Geometry
                this.geometryPattern = [];
                this.targetPattern = [24, 25, 26, 17, 18, 19, 10, 11, 12, 31, 32, 33, 38, 39, 40, 45, 46, 47]; // Flower of Life
                
                // Stage 3: Chakra System
                this.chakraSequence = [];
                this.chakraTargets = ['root', 'sacral', 'solar', 'heart', 'throat', 'third-eye', 'crown'];
                this.cosmicTimer = null;
                this.lastActivation = 0;
                
                this.hintsUsed = 0;
                this.startTime = Date.now();
                this.artifacts = [];
                
                this.initializeCharacter();
                this.setupEventListeners();
            }
            
            initializeCharacter() {
                // Extract character data from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const nakshatraNum = urlParams.get('nakshatra');
                const guna1 = urlParams.get('guna1');
                const pada = urlParams.get('pada');
                const guna3 = urlParams.get('guna3');

                console.log('Loading character data:', { nakshatraNum, guna1, pada, guna3 });

                // Complete Nakshatra data mapping
                const nakshatraData = {
                    1: { name: 'Ashwini', gana: 'Deva', element: 'fire', shakti: 'To heal quickly' },
                    2: { name: 'Bharani', gana: 'Manushya', element: 'earth', shakti: 'To renew and purify' },
                    3: { name: 'Krittika', gana: 'Rakshasa', element: 'fire', shakti: 'To burn illusion' },
                    4: { name: 'Rohini', gana: 'Manushya', element: 'earth', shakti: 'To make things grow' },
                    5: { name: 'Mrigashira', gana: 'Deva', element: 'air', shakti: 'To find fulfillment' },
                    6: { name: 'Ardra', gana: 'Manushya', element: 'water', shakti: 'To feel and act' },
                    7: { name: 'Punarvasu', gana: 'Deva', element: 'air', shakti: 'To regenerate and recover' },
                    8: { name: 'Pushya', gana: 'Deva', element: 'water', shakti: 'To create spiritual energy' },
                    9: { name: 'Ashlesha', gana: 'Rakshasa', element: 'water', shakti: 'To poison and heal' },
                    10: { name: 'Magha', gana: 'Rakshasa', element: 'fire', shakti: 'To leave the body' },
                    11: { name: 'Purva Phalguni', gana: 'Manushya', element: 'fire', shakti: 'To find love and enjoyment' },
                    12: { name: 'Uttara Phalguni', gana: 'Manushya', element: 'fire', shakti: 'To accumulate security' },
                    13: { name: 'Hasta', gana: 'Manushya', element: 'fire', shakti: 'To manifest desires' },
                    14: { name: 'Chitra', gana: 'Rakshasa', element: 'fire', shakti: 'To gather merit' },
                    15: { name: 'Swati', gana: 'Deva', element: 'air', shakti: 'To scatter and disperse' },
                    16: { name: 'Vishakha', gana: 'Rakshasa', element: 'fire', shakti: 'To achieve goals' },
                    17: { name: 'Anuradha', gana: 'Deva', element: 'water', shakti: 'To worship and connect' },
                    18: { name: 'Jyeshtha', gana: 'Rakshasa', element: 'air', shakti: 'To be eldest' },
                    19: { name: 'Mula', gana: 'Rakshasa', element: 'air', shakti: 'To destroy' },
                    20: { name: 'Purva Ashadha', gana: 'Manushya', element: 'water', shakti: 'To invigorate' },
                    21: { name: 'Uttara Ashadha', gana: 'Manushya', element: 'water', shakti: 'To gain victory' },
                    22: { name: 'Shravana', gana: 'Deva', element: 'air', shakti: 'To connect and link' },
                    23: { name: 'Dhanishta', gana: 'Rakshasa', element: 'air', shakti: 'To give fame' },
                    24: { name: 'Shatabhisha', gana: 'Rakshasa', element: 'air', shakti: 'To heal' },
                    25: { name: 'Purva Bhadrapada', gana: 'Manushya', element: 'air', shakti: 'To raise up' },
                    26: { name: 'Uttara Bhadrapada', gana: 'Manushya', element: 'air', shakti: 'To bring rain' },
                    27: { name: 'Revati', gana: 'Deva', element: 'air', shakti: 'To nourish and protect' }
                };

                // Initialize GameStateManager with character data
                if (nakshatraNum && nakshatraData[nakshatraNum]) {
                    const nakshatra = nakshatraData[nakshatraNum];

                    // Set character data in GameStateManager
                    window.gameStateManager.playerProfile = {
                        nakshatra: nakshatra.name,
                        gana: nakshatra.gana,
                        shakti: nakshatra.shakti,
                        gunas: {
                            sattva: guna1 === 'Sattva' ? 2 : (guna3 === 'Sattva' ? 1 : 0),
                            rajas: guna1 === 'Rajas' ? 2 : (guna3 === 'Rajas' ? 1 : 0),
                            tamas: guna1 === 'Tamas' ? 2 : (guna3 === 'Tamas' ? 1 : 0)
                        },
                        pada: pada || 'Dharma',
                        avatar: `images/avatars/${nakshatra.gana.toLowerCase()}.png`
                    };

                    // Initialize game state for ACT 1
                    window.gameStateManager.playerState.currentAct = 1;
                    window.gameStateManager.playerState.currentSceneId = 'JOURNEY_START';

                    // Save the character data
                    window.gameStateManager.saveGame();

                    // Update display
                    document.getElementById('character-name').textContent = nakshatra.name;
                    document.getElementById('character-gana').textContent = nakshatra.gana + ' Gana';

                    console.log('Character initialized:', window.gameStateManager.playerProfile);
                } else {
                    console.warn('Invalid or missing character data in URL');
                    // Set default character data
                    window.gameStateManager.playerProfile = {
                        nakshatra: 'Uttara Phalguni',
                        gana: 'Manushya',
                        shakti: 'To accumulate security',
                        gunas: { sattva: 1, rajas: 2, tamas: 1 },
                        pada: 'Dharma',
                        avatar: 'images/avatars/manushya.png'
                    };
                    window.gameStateManager.playerState.currentAct = 1;
                    window.gameStateManager.playerState.currentSceneId = 'JOURNEY_START';
                }

                this.updateDisplay();
                this.initializeStoryEngine();
                this.initializeStage1();
            }

            // ===== STORY ENGINE INTEGRATION =====
            initializeStoryEngine() {
                // Initialize story engine with game state manager
                if (window.StoryEngine && window.gameStateManager) {
                    this.storyEngine = new window.StoryEngine(window.gameStateManager);
                    console.log('Story engine initialized');

                    // Add story interface after master puzzle
                    this.createStoryInterface();
                } else {
                    console.warn('StoryEngine or GameStateManager not available');
                }
            }

            createStoryInterface() {\n                // Add story section to the main panel\n                const mainPanel = document.querySelector('.main-panel');\n                const storySection = document.createElement('div');\n                storySection.id = 'story-section';\n                storySection.innerHTML = `\n                    <div style=\"margin: 3rem 0; padding: 2rem; background: rgba(26, 24, 23, 0.6); border: 2px solid rgba(99, 180, 209, 0.3); border-radius: 15px;\">\n                        <h2 style=\"font-family: var(--font-title); font-size: 2rem; color: var(--color-info); text-align: center; margin-bottom: 1.5rem;\">Begin Your Samsara Saga</h2>\n                        <p style=\"text-align: center; font-size: 1.1rem; margin-bottom: 2rem; color: var(--color-text);\">Complete the Master's Trials above, or begin your story journey immediately.</p>\n                        <div style=\"text-align: center;\">\n                            <button class=\"control-btn btn-info\" onclick=\"masterGameState.startStoryMode()\" style=\"font-size: 1.1rem; padding: 1rem 2rem;\">\n                                🌟 Enter the Story Realm\n                            </button>\n                        </div>\n                    </div>\n                    <div id=\"story-gameplay\" style=\"display: none;\">\n                        <div id=\"story-content\" style=\"background: rgba(26, 24, 23, 0.8); border: 2px solid rgba(99, 180, 209, 0.3); border-radius: 15px; padding: 2rem; margin: 2rem 0;\">\n                            <h3 id=\"story-title\" style=\"font-family: var(--font-title); font-size: 1.8rem; color: var(--color-info); margin-bottom: 1rem;\"></h3>\n                            <div id=\"story-text\" style=\"font-size: 1.1rem; line-height: 1.6; margin-bottom: 2rem; color: var(--color-text);\"></div>\n                            <div id=\"story-choices\" style=\"display: flex; flex-direction: column; gap: 1rem;\"></div>\n                        </div>\n                    </div>\n                `;\n                \n                // Insert after the master puzzle container\n                const puzzleContainer = document.querySelector('.master-puzzle-container');\n                puzzleContainer.parentNode.insertBefore(storySection, puzzleContainer.nextSibling);\n            }\n            \n            startStoryMode() {\n                console.log('Starting story mode...');\n                \n                // Hide the story intro and show the gameplay\n                const storySection = document.getElementById('story-section');\n                const storyIntro = storySection.children[0];\n                const storyGameplay = document.getElementById('story-gameplay');\n                \n                storyIntro.style.display = 'none';\n                storyGameplay.style.display = 'block';\n                \n                // Load the current scene\n                this.loadCurrentScene();\n            }\n            \n            loadCurrentScene() {\n                if (!this.storyEngine) {\n                    console.error('Story engine not initialized');\n                    return;\n                }\n                \n                const scene = this.storyEngine.getCurrentScene();\n                if (!scene) {\n                    console.error('No current scene found');\n                    return;\n                }\n                \n                // Update story display\n                document.getElementById('story-title').textContent = scene.title || 'Untitled Scene';\n                document.getElementById('story-text').textContent = scene.text || 'No description available.';\n                \n                // Load choices\n                this.loadStoryChoices();\n            }\n            \n            loadStoryChoices() {\n                const choices = this.storyEngine.getAvailableChoices();\n                const choicesContainer = document.getElementById('story-choices');\n                choicesContainer.innerHTML = '';\n                \n                choices.forEach(choice => {\n                    const choiceButton = document.createElement('button');\n                    choiceButton.className = 'control-btn btn-secondary';\n                    choiceButton.style.padding = '1rem 1.5rem';\n                    choiceButton.style.textAlign = 'left';\n                    choiceButton.style.fontSize = '1rem';\n                    choiceButton.textContent = choice.text || 'Unnamed choice';\n                    \n                    choiceButton.addEventListener('click', () => {\n                        this.makeChoice(choice.id || choice.nextScene);\n                    });\n                    \n                    choicesContainer.appendChild(choiceButton);\n                });\n            }\n            \n            makeChoice(choiceId) {\n                console.log('Making choice:', choiceId);\n                \n                if (this.storyEngine.processChoice(choiceId)) {\n                    // Choice was processed successfully, reload the scene\n                    setTimeout(() => {\n                        this.loadCurrentScene();\n                    }, 500);\n                } else {\n                    console.error('Failed to process choice:', choiceId);\n                }\n            }
            
            setupEventListeners() {
                // Prevent any auto-refresh mechanisms
                window.onbeforeunload = () => this.saveProgress();
                
                // Disable problematic shortcuts that might cause refresh
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
                        e.preventDefault();
                        this.showNotification('Auto-refresh disabled. Use Save Progress to preserve your journey.', 'info');
                    }
                });
            }
            
            updateDisplay() {
                document.getElementById('karma-value').textContent = this.playerStats.karma;
                document.getElementById('mastery-level').textContent = this.playerStats.masteryLevel;
                document.getElementById('trials-completed').textContent = `${this.playerStats.trialsCompleted}/3`;
                document.getElementById('wisdom-gained').textContent = this.playerStats.wisdomGained;
                document.getElementById('attunement').textContent = `${this.playerStats.attunement}%`;
            }
            
            // ===== STAGE 1: HARMONIC RESONANCE =====
            initializeStage1() {
                // Set up frequency controls
                for (let i = 1; i <= 3; i++) {
                    const slider = document.getElementById(`freq-${i}`);
                    const wheel = document.getElementById(`wheel-${i}`);
                    const marker = document.getElementById(`marker-${i}`);
                    const display = document.getElementById(`display-${i}`);

                    // Add event listeners
                    slider.addEventListener('input', () => this.updateFrequency(i));
                    if (wheel) {
                        wheel.addEventListener('click', () => this.adjustFrequency(i));
                    }

                    this.updateFrequency(i);
                }
            }

            adjustFrequency(chamber) {
                // Rotate frequency wheel by 30 degrees when clicked
                const slider = document.getElementById(`freq-${chamber}`);
                const currentValue = parseInt(slider.value);
                const newValue = (currentValue + 30) % 360;
                slider.value = newValue;
                this.updateFrequency(chamber);
            }
            
            updateFrequency(chamber) {
                const slider = document.getElementById(`freq-${chamber}`);
                const marker = document.getElementById(`marker-${chamber}`);
                const display = document.getElementById(`display-${chamber}`);

                // Safety checks
                if (!slider || !marker || !display) {
                    console.warn(`Missing frequency elements for chamber ${chamber}`);
                    return;
                }

                const angle = slider.value;
                this.harmonics[`freq${chamber}`] = parseInt(angle);

                // Update visual marker
                marker.style.transform = `translateX(-50%) rotate(${angle}deg) translateY(-55px)`;

                // Calculate frequency based on angle (sacred mathematics)
                const baseFreq = [432, 528, 639][chamber - 1];
                const frequency = Math.round(baseFreq + (angle / 360) * 200);
                display.textContent = `${frequency} Hz`;

                // Check for harmonic resonance in real-time
                this.checkHarmonicResonance();
            }
            
            checkHarmonicResonance() {
                const target1 = 108; // 108 degrees - sacred number
                const target2 = 144; // 144 degrees - 108 * 4/3
                const target3 = 180; // 180 degrees - 108 * 5/3
                const tolerance = 8;
                
                const freq1 = this.harmonics.freq1;
                const freq2 = this.harmonics.freq2;
                const freq3 = this.harmonics.freq3;
                
                const aligned = Math.abs(freq1 - target1) <= tolerance &&
                               Math.abs(freq2 - target2) <= tolerance &&
                               Math.abs(freq3 - target3) <= tolerance;
                
                if (aligned && this.currentStage === 1) {
                    this.completeStage(1);
                }
            }
            
            // ===== STAGE 2: SACRED GEOMETRY =====
            initializeStage2() {
                const grid = document.getElementById('geometry-grid');
                grid.innerHTML = '';
                
                // Create 7x7 grid (49 nodes total)
                for (let i = 0; i < 49; i++) {
                    const node = document.createElement('div');
                    node.className = 'geometry-node';
                    node.dataset.index = i;
                    node.addEventListener('click', () => this.activateGeometryNode(i));
                    
                    // Add sacred symbols to specific nodes
                    const symbols = ['⬢', '◈', '◉', '⬟', '◎', '◈', '⬢'];
                    if (this.targetPattern.includes(i)) {
                        node.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                    }
                    
                    grid.appendChild(node);
                }
            }
            
            activateGeometryNode(index) {
                if (this.currentStage !== 2) return;
                
                const node = document.querySelector(`[data-index="${index}"]`);
                
                if (this.geometryPattern.includes(index)) {
                    // Already activated - deactivate
                    this.geometryPattern = this.geometryPattern.filter(i => i !== index);
                    node.classList.remove('activated');
                } else {
                    // Activate node
                    this.geometryPattern.push(index);
                    node.classList.add('activated');
                    
                    // Check if pattern is correct so far
                    const isCorrect = this.geometryPattern.every((nodeIndex, i) => 
                        nodeIndex === this.targetPattern[i]
                    );
                    
                    if (!isCorrect) {
                        // Wrong pattern - shake and reset
                        node.classList.add('incorrect');
                        setTimeout(() => {
                            this.resetGeometryPattern();
                        }, 1000);
                        this.showFeedback('The sacred geometry rebels against disorder. Start anew.', 'error');
                        return;
                    }
                    
                    node.classList.add('correct');
                    
                    // Check if complete
                    if (this.geometryPattern.length === this.targetPattern.length) {
                        this.completeStage(2);
                    }
                }
            }
            
            resetGeometryPattern() {
                this.geometryPattern = [];
                document.querySelectorAll('.geometry-node').forEach(node => {
                    node.classList.remove('activated', 'correct', 'incorrect');
                });
            }
            
            // ===== STAGE 3: CHAKRA AWAKENING =====
            initializeStage3() {
                const mandala = document.getElementById('chakra-mandala');
                mandala.innerHTML = '';
                
                const chakras = [
                    { name: 'root', color: '#e74c3c', symbol: '🔴', angle: 270, label: 'Root' },
                    { name: 'sacral', color: '#e67e22', symbol: '🟠', angle: 315, label: 'Sacral' },
                    { name: 'solar', color: '#f1c40f', symbol: '🟡', angle: 0, label: 'Solar' },
                    { name: 'heart', color: '#27ae60', symbol: '💚', angle: 45, label: 'Heart' },
                    { name: 'throat', color: '#3498db', symbol: '🔵', angle: 90, label: 'Throat' },
                    { name: 'third-eye', color: '#8e44ad', symbol: '🟣', angle: 135, label: 'Third Eye' },
                    { name: 'crown', color: '#9b59b6', symbol: '👑', angle: 180, label: 'Crown' }
                ];
                
                chakras.forEach((chakra, index) => {
                    const chakraElement = document.createElement('div');
                    chakraElement.className = 'chakra-point';
                    chakraElement.dataset.chakra = chakra.name;
                    chakraElement.dataset.index = index;
                    chakraElement.style.borderColor = chakra.color;
                    chakraElement.textContent = chakra.symbol;
                    chakraElement.title = chakra.label;
                    
                    // Position on mandala
                    const radian = (chakra.angle * Math.PI) / 180;
                    const radius = 150;
                    const x = 200 + radius * Math.cos(radian) - 30;
                    const y = 200 + radius * Math.sin(radian) - 30;
                    
                    chakraElement.style.left = x + 'px';
                    chakraElement.style.top = y + 'px';
                    
                    chakraElement.addEventListener('click', () => this.activateChakra(chakra.name, index));
                    mandala.appendChild(chakraElement);
                });
                
                this.setupChakraSequence();
                this.startCosmicTimer();
            }
            
            setupChakraSequence() {
                const sequenceContainer = document.getElementById('chakra-sequence');
                sequenceContainer.innerHTML = '';
                
                this.chakraTargets.forEach((chakra, index) => {
                    const step = document.createElement('div');
                    step.className = 'sequence-step';
                    step.dataset.chakra = chakra;
                    step.textContent = index + 1;
                    sequenceContainer.appendChild(step);
                });
                
                // Highlight first step
                sequenceContainer.children[0].classList.add('active');
            }
            
            startCosmicTimer() {
                this.cosmicTimer = setInterval(() => {
                    // Cosmic pulse every 3 seconds
                    document.querySelectorAll('.chakra-point').forEach(chakra => {
                        chakra.style.boxShadow = '0 0 30px currentColor';
                        setTimeout(() => {
                            chakra.style.boxShadow = '';
                        }, 500);
                    });
                }, 3000);
            }
            
            activateChakra(chakraName, index) {
                if (this.currentStage !== 3) return;
                
                const now = Date.now();
                const timeSinceLastActivation = now - this.lastActivation;
                
                // Check timing (must be within cosmic window)
                if (this.chakraSequence.length > 0 && timeSinceLastActivation < 2800) {
                    this.showFeedback('Wait for the cosmic pulse... timing is essential.', 'warning');
                    return;
                }
                
                const expectedChakra = this.chakraTargets[this.chakraSequence.length];
                
                if (chakraName === expectedChakra) {
                    // Correct chakra and timing
                    this.chakraSequence.push(chakraName);
                    this.lastActivation = now;
                    
                    const chakraElement = document.querySelector(`[data-chakra="${chakraName}"]`);
                    chakraElement.classList.add('activated');
                    
                    // Update sequence display
                    const sequenceSteps = document.querySelectorAll('.sequence-step');
                    sequenceSteps[this.chakraSequence.length - 1].classList.remove('active');
                    sequenceSteps[this.chakraSequence.length - 1].classList.add('completed');
                    
                    if (this.chakraSequence.length < this.chakraTargets.length) {
                        sequenceSteps[this.chakraSequence.length].classList.add('active');
                    }
                    
                    this.showFeedback(`${chakraName.charAt(0).toUpperCase() + chakraName.slice(1)} chakra awakened! Energy flows upward...`, 'success');
                    
                    if (this.chakraSequence.length === this.chakraTargets.length) {
                        this.completeStage(3);
                    }
                } else {
                    // Wrong chakra - reset entire sequence
                    this.showFeedback('The chakras must be awakened in sacred order. Beginning anew...', 'error');
                    this.resetChakraSequence();
                }
            }
            
            resetChakraSequence() {
                this.chakraSequence = [];
                document.querySelectorAll('.chakra-point').forEach(chakra => {
                    chakra.classList.remove('activated');
                });
                
                // Reset sequence display
                const sequenceSteps = document.querySelectorAll('.sequence-step');
                sequenceSteps.forEach((step, index) => {
                    step.classList.remove('active', 'completed');
                    if (index === 0) step.classList.add('active');
                });
            }
            
            // ===== STAGE MANAGEMENT =====
            completeStage(stageNum) {
                if (this.completedStages.includes(stageNum)) return;
                
                this.completedStages.push(stageNum);
                
                // Update stage indicator
                const indicator = document.querySelector(`[data-stage="${stageNum}"]`);
                indicator.classList.remove('active', 'locked');
                indicator.classList.add('completed');
                indicator.innerHTML = '✓';
                
                // Calculate rewards based on performance
                const timeBonus = Math.max(0, 300 - Math.floor((Date.now() - this.startTime) / 1000));
                const hintPenalty = this.hintsUsed * 10;
                const stageReward = 100 + timeBonus - hintPenalty;
                
                this.playerStats.karma += stageReward;
                this.playerStats.wisdomGained += 25;
                this.playerStats.trialsCompleted = this.completedStages.length;
                this.playerStats.attunement = Math.min(100, this.playerStats.attunement + 20);
                
                // Update mastery level
                if (this.completedStages.length === 1) {
                    this.playerStats.masteryLevel = 'Apprentice';
                } else if (this.completedStages.length === 2) {
                    this.playerStats.masteryLevel = 'Adept';
                } else if (this.completedStages.length === 3) {
                    this.playerStats.masteryLevel = 'Master';
                }
                
                this.updateDisplay();
                
                const stageNames = ['Harmonic Resonance', 'Sacred Geometry', 'Chakra Awakening'];
                this.showFeedback(`🌟 Stage ${stageNum} Complete: ${stageNames[stageNum - 1]} Mastered! (+${stageReward} Karma)`, 'success');
                
                // Add artifacts
                const artifacts = [
                    '🎵 Resonance Crystal',
                    '⬢ Sacred Geometry Codex', 
                    '👑 Chakra Awakening Crown'
                ];
                this.artifacts.push(artifacts[stageNum - 1]);
                this.updateArtifacts();
                
                if (stageNum < 3) {
                    setTimeout(() => this.advanceToStage(stageNum + 1), 2000);
                } else {
                    setTimeout(() => this.completePuzzle(), 2000);
                }
            }
            
            advanceToStage(stageNum) {
                // Hide current stage
                document.querySelector('.puzzle-stage.active').classList.remove('active');
                
                // Show next stage
                const nextStage = document.getElementById(`stage-${stageNum}`);
                nextStage.classList.add('active');
                this.currentStage = stageNum;
                
                // Update stage indicator
                const indicator = document.querySelector(`[data-stage="${stageNum}"]`);
                indicator.classList.remove('locked');
                indicator.classList.add('active');
                
                // Initialize stage-specific mechanics
                if (stageNum === 2) {
                    this.initializeStage2();
                } else if (stageNum === 3) {
                    this.initializeStage3();
                }
                
                this.showFeedback(`Advancing to Stage ${stageNum}. The challenge deepens...`, 'info');
            }
            
            completePuzzle() {
                this.showFeedback('🌳 THE BANYAN TREE AWAKENS! You have achieved perfect mastery of all three sacred trials. The ancient wisdom flows through you...', 'success');
                
                // Massive final rewards
                this.playerStats.karma += 500;
                this.playerStats.wisdomGained += 100;
                this.playerStats.attunement = 100;
                this.artifacts.push('🌳 Banyan\'s Eternal Blessing');
                
                this.updateDisplay();
                this.updateArtifacts();
                
                // Clear cosmic timer
                if (this.cosmicTimer) {
                    clearInterval(this.cosmicTimer);
                }
                
                setTimeout(() => {
                    this.showCompletionScreen();
                }, 3000);
            }
            
            showCompletionScreen() {
                const mainPanel = document.querySelector('.main-panel');
                mainPanel.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h2 style="font-family: var(--font-title); font-size: 3rem; color: var(--color-primary-glow); margin-bottom: 2rem;">
                            🌳 THE BANYAN'S GRATITUDE 🌳
                        </h2>
                        
                        <div style="font-size: 1.4rem; line-height: 1.8; margin-bottom: 2rem; max-width: 800px; margin-left: auto; margin-right: auto;">
                            <p>As the final chakra blazes with awakened light, the Great Banyan tree straightens to its full cosmic height. Its roots dig deeper into the earth while its crown touches the heavens.</p>
                            
                            <p style="margin: 2rem 0; color: var(--color-primary-glow); font-weight: bold;">
                                "You have achieved what few mortals ever attempt and fewer still complete. Accept my eternal blessing, Master of the Three Realms."
                            </p>
                            
                            <p>The tree's wisdom flows into you—knowledge of harmonic frequencies that heal, sacred geometries that unlock reality's blueprints, and chakra mastery that bridges earth and sky.</p>
                            
                            <p>You are no longer the same being who began this trial. You are transformed.</p>
                        </div>
                        
                        <div style="display: flex; gap: 2rem; justify-content: center; flex-wrap: wrap; margin-top: 3rem;">
                            <button class="control-btn btn-primary" onclick="continueEpicJourney()" style="font-size: 1.2rem; padding: 1rem 2rem;">
                                🚀 Continue Epic Journey
                            </button>
                            <button class="control-btn btn-secondary" onclick="enterDeepMeditation()" style="font-size: 1.2rem; padding: 1rem 2rem;">
                                🧘 Enter Deep Meditation
                            </button>
                            <button class="control-btn btn-info" onclick="shareWisdom()" style="font-size: 1.2rem; padding: 1rem 2rem;">
                                📜 Share Wisdom
                            </button>
                        </div>
                        
                        <div style="margin-top: 3rem; padding: 2rem; background: rgba(139, 92, 246, 0.1); border-radius: 15px; border: 2px solid var(--color-cosmic);">
                            <h3 style="color: var(--color-cosmic); margin-bottom: 1rem;">🏆 Master's Achievements</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; text-align: left;">
                                <div>✨ Harmonic Resonance Master</div>
                                <div>⬢ Sacred Geometry Sage</div>
                                <div>👑 Chakra Awakening Adept</div>
                                <div>🌳 Banyan Tree Blessed</div>
                                <div>🎯 Perfect Cosmic Attunement</div>
                                <div>🧘 Transcendent Consciousness</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            updateArtifacts() {
                const artifactsList = document.getElementById('artifacts-list');
                if (this.artifacts.length === 0) {
                    artifactsList.innerHTML = '<div style="color: var(--color-text-muted); font-style: italic;">Complete trials to unlock sacred artifacts...</div>';
                } else {
                    artifactsList.innerHTML = this.artifacts.map(artifact => 
                        `<div style="margin: 0.5rem 0; padding: 0.5rem; background: rgba(139, 92, 246, 0.1); border-radius: 5px; color: var(--color-cosmic);">${artifact}</div>`
                    ).join('');
                }
            }
            
            showFeedback(message, type = 'info') {
                const feedback = document.getElementById('feedback-message');
                if (!feedback) {
                    console.warn('Feedback element not found');
                    return;
                }

                feedback.textContent = message;
                feedback.className = `feedback-message feedback-${type} show`;

                setTimeout(() => {
                    if (feedback) {
                        feedback.classList.remove('show');
                    }
                }, 4000);
            }
            
            showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                const icons = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    info: 'fas fa-info-circle',
                    warning: 'fas fa-exclamation-triangle'
                };
                
                notification.innerHTML = `
                    <div class="notification-content">
                        <i class="notification-icon ${icons[type] || icons.info}"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                container.appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 100);
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 500);
                }, 5000);
            }
            
            saveProgress() {
                const saveData = {
                    gameState: {
                        currentStage: this.currentStage,
                        completedStages: this.completedStages,
                        playerStats: this.playerStats,
                        harmonics: this.harmonics,
                        geometryPattern: this.geometryPattern,
                        chakraSequence: this.chakraSequence,
                        artifacts: this.artifacts,
                        hintsUsed: this.hintsUsed
                    },
                    timestamp: new Date().toISOString()
                };
                
                try {
                    localStorage.setItem('samsaraSagaMasterSave', JSON.stringify(saveData));
                    this.showNotification('Master\'s progress preserved in the cosmic record!', 'success');
                } catch (error) {
                    this.showNotification('Failed to preserve progress. The cosmic forces resist...', 'error');
                }
            }
        }
        
        // ===== GLOBAL FUNCTIONS =====
        let gameState;

        // Global notification function for early error handling
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            if (!container) {
                console.log(`Notification: ${message}`);
                return;
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;

            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                info: 'fas fa-info-circle',
                warning: 'fas fa-exclamation-triangle'
            };

            notification.innerHTML = `
                <div class="notification-content">
                    <i class="notification-icon ${icons[type] || icons.info}"></i>
                    <span>${message}</span>
                </div>
            `;

            container.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }
        
        // Initialize game
        document.addEventListener('DOMContentLoaded', () => {
            try {
                gameState = new MasterGameState();
                console.log('🌟 Samsara Saga Master\'s Trial initialized successfully!');

                // Ensure all elements are properly initialized
                const criticalElements = ['freq-1', 'freq-2', 'freq-3', 'feedback-message', 'notification-container'];
                const missingElements = criticalElements.filter(id => !document.getElementById(id));

                if (missingElements.length > 0) {
                    console.error('Critical UI elements missing:', missingElements);
                    showNotification('Game initialization incomplete. Some elements are missing.', 'error');
                    // Continue anyway, but with warnings
                }

                showNotification('🌟 Master\'s Trial Ready! Begin your cosmic journey...', 'success');

            } catch (error) {
                console.error('Game initialization failed:', error);
                showNotification('Failed to initialize game. Please refresh the page.', 'error');
            }
        });
        
        // Control functions
        function updateFrequency(chamber) {
            gameState.updateFrequency(chamber);
        }

        function adjustFrequency(chamber) {
            if (gameState) {
                gameState.adjustFrequency(chamber);
            }
        }
        
        function checkCurrentStage() {
            if (!gameState) {
                showNotification('Game not yet initialized. Please wait...', 'warning');
                return;
            }

            switch (gameState.currentStage) {
                case 1:
                    gameState.checkHarmonicResonance();
                    if (!gameState.completedStages.includes(1)) {
                        gameState.showFeedback('The harmonics are not yet aligned. Seek the sacred ratio of 3:4:5.', 'warning');
                    }
                    break;
                case 2:
                    if (gameState.geometryPattern.length === 0) {
                        gameState.showFeedback('Begin by activating the center node, then follow the sacred flower pattern.', 'hint');
                    } else if (gameState.geometryPattern.length < gameState.targetPattern.length) {
                        gameState.showFeedback(`Pattern progress: ${gameState.geometryPattern.length}/${gameState.targetPattern.length} nodes activated.`, 'info');
                    }
                    break;
                case 3:
                    if (gameState.chakraSequence.length === 0) {
                        gameState.showFeedback('Begin with the Root chakra and ascend mindfully. Wait for the cosmic pulse.', 'hint');
                    } else {
                        gameState.showFeedback(`Chakra awakening progress: ${gameState.chakraSequence.length}/7 chakras activated.`, 'info');
                    }
                    break;
            }
        }
        
        function getStageHint() {
            if (!gameState) {
                showNotification('Game not yet initialized. Please wait...', 'warning');
                return;
            }

            gameState.hintsUsed++;

            const hints = {
                1: "The sacred frequencies form a mathematical relationship. Sattva at 108°, Rajas at 144°, Tamas at 180°. Listen for the harmonic convergence.",
                2: "The Flower of Life begins at the center and radiates outward. Activate the central node first, then the six surrounding petals in clockwise order.",
                3: "Each chakra must be activated within 3 seconds of the cosmic pulse. Start from the base and rise: Root → Sacral → Solar → Heart → Throat → Third Eye → Crown."
            };

            gameState.showFeedback(`Cosmic Guidance: ${hints[gameState.currentStage]}`, 'hint');

            // Small karma penalty for hints
            gameState.playerStats.karma = Math.max(0, gameState.playerStats.karma - 5);
            gameState.updateDisplay();
        }

        function resetCurrentStage() {
            if (!gameState) {
                showNotification('Game not yet initialized. Please wait...', 'warning');
                return;
            }

            switch (gameState.currentStage) {
                case 1:
                    // Reset to random positions
                    for (let i = 1; i <= 3; i++) {
                        const slider = document.getElementById(`freq-${i}`);
                        if (slider) {
                            const randomAngle = Math.floor(Math.random() * 360);
                            slider.value = randomAngle;
                            gameState.updateFrequency(i);
                        }
                    }
                    break;
                case 2:
                    gameState.resetGeometryPattern();
                    break;
                case 3:
                    gameState.resetChakraSequence();
                    break;
            }
            gameState.showFeedback('Stage reset. Begin anew with deeper understanding.', 'info');
        }

        function skipToNextQuest() {
            if (confirm('🚨 Skip this profound trial? You will miss the deepest spiritual rewards and cosmic attunement. Continue?')) {
                continueEpicJourney();
            }
        }

        function saveProgress() {
            if (!gameState) {
                showNotification('Game not yet initialized. Nothing to save.', 'warning');
                return;
            }
            gameState.saveProgress();
        }

        function viewGrandDesign() {
            if (!gameState) {
                showNotification('Game not yet initialized. Please wait...', 'warning');
                return;
            }
            gameState.showNotification('The Grand Design reveals itself only to those who complete all trials...', 'info');
        }

        function enterMeditation() {
            if (!gameState) {
                showNotification('Game not yet initialized. Please wait...', 'warning');
                return;
            }
            gameState.playerStats.karma += 10;
            gameState.playerStats.attunement = Math.min(100, gameState.playerStats.attunement + 2);
            gameState.updateDisplay();
            gameState.showNotification('Through meditation, cosmic clarity increases...', 'success');
        }
        
        // Completion screen functions
        function continueEpicJourney() {
            if (gameState) {
                gameState.showNotification('Your epic journey continues beyond the Banyan\'s realm...', 'success');
            } else {
                showNotification('Your epic journey continues beyond the Banyan\'s realm...', 'success');
            }
            // Here you would transition to the next major quest/area
        }

        function enterDeepMeditation() {
            if (gameState) {
                gameState.showNotification('You enter the deepest meditation, integrating the Banyan\'s wisdom into your very essence...', 'success');
            } else {
                showNotification('You enter the deepest meditation, integrating the Banyan\'s wisdom into your very essence...', 'success');
            }
        }

        function shareWisdom() {
            if (gameState) {
                gameState.showNotification('Your wisdom will inspire countless others on their spiritual journey...', 'success');
            } else {
                showNotification('Your wisdom will inspire countless others on their spiritual journey...', 'success');
            }
        }
        
        // Prevent any auto-refresh or reload mechanisms
        window.addEventListener('beforeunload', (e) => {
            gameState.saveProgress();
        });
        
        // No automatic refresh mechanisms in this version
        console.log('🚫 Auto-refresh permanently disabled. Manual save/load system active.');
    </script>
</body>
</html>
